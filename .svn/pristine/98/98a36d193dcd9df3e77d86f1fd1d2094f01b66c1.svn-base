var add_flg='';
$(document).ready(function() { 
if($( window ).width() <= 767)
{
	$('.large-only').html(" ");
} else {
	$('.small-only').html(" ");
}
	//$('#non_doobert_user_phone').inputmask("(999) 999-9999");
	$('#non_doobert_user_phone').mask('(999) 999-9999',{placeholder: "(___) ___-____"},{'translation': {9: {pattern: /[0-9*]/,optional:false}}});
});
var from_date_setup;
var to_date_setup;
var from_date_setup_year;
var to_date_setup_year;
$(document).ready(function(){		
	$('.from_date').datetimepicker({ 
    endDate: end_date,    
	format: "D M dd - HH:ii P",
	showMeridian: true,
	autoclose: true,
	pickerPosition: "bottom-left",
	startDate:start_date	
}).on('changeDate', function(e) {
	var d = new Date(e.date);
	var y = d.getFullYear();
	if($('#route_type_id').val()=='0')
	{
		from_date_setup = $('#clockface_2_modal').val();
		from_date_setup_year = 	d.getFullYear();
	} else 	if($('#route_type_id').val()=='1')
	{
		from_date_setup = $('#pickup_airport_clock').val();
		from_date_setup_year = 	d.getFullYear();
	} else 	if($('#route_type_id').val()=='3')
	{
		from_date_setup = $('#pickup_airline_clock').val();
		from_date_setup_year = 	d.getFullYear();
	}
}).on('hide', function(e) {
	if($('#route_type_id').val()=='0')
	{
		$('#clockface_2_modal').val(from_date_setup);
		$('#clockface_2_modal_year').val(from_date_setup_year);	
	} else 	if($('#route_type_id').val()=='1')
	{
		 $('#pickup_airport_clock').val(from_date_setup);
		 $('#pickup_airport_clock_year').val(from_date_setup_year);
	}
	else if($('#route_type_id').val()=='3')
	{
		 $('#pickup_airline_clock').val(from_date_setup);
		 $('#pickup_airline_clock_year').val(from_date_setup_year);
	}
});	
	

$('.to_date').datetimepicker({
        endDate: end_date,
		format: "D M dd - HH:ii P",
		showMeridian: true,
		autoclose: true,
		//todayBtn: false,
		pickerPosition: "bottom-left",
		startDate: start_date
    }).on('changeDate', function(e) {
	var d = new Date(e.date);
	var y = d.getFullYear();	
	if($('#route_type_id').val()=='0')
	{
		to_date_setup = $('#clockface_3_modal').val();
		to_date_setup_year = d.getFullYear();	
		//$('#clockface_3_modal_year').val(d.getFullYear());	
	} else 	if($('#route_type_id').val()=='1')
	{
		to_date_setup = $('#dropoff_airport_clock').val();
		to_date_setup_year = d.getFullYear();
		//$('#dropoff_airport_clock_year').val(d.getFullYear());
	}else 	if($('#route_type_id').val()=='3')
	{
		to_date_setup = $('#dropoff_airline_clock').val();
		to_date_setup_year = d.getFullYear();
		//$('#dropoff_airline_clock_year').val(d.getFullYear());
	}
}).on('hide', function(e) {
	if($('#route_type_id').val()=='0')
	{
		$('#clockface_3_modal').val(to_date_setup);
		$('#clockface_3_modal_year').val(to_date_setup_year);	
	} else 	if($('#route_type_id').val()=='1')
	{
		 $('#dropoff_airport_clock').val(to_date_setup);
		 $('#dropoff_airport_clock_year').val(to_date_setup_year);
	} else 	if($('#route_type_id').val()=='3')
	{
		 $('#dropoff_airline_clock').val(to_date_setup);
		 $('#dropoff_airline_clock_year').val(to_date_setup_year);
	}
	
});	
});

/*$(document).on('keydown', '.from_date',    function(event) {
    $.Datetimepicker.keydown(event);
});*/

$('#'+file_divid).fileupload({
		  url: upload_link,
		  maxNumberOfFiles: 5,
		  maxFileSize : 5242880,
		  acceptFileTypes :/(\.|\/)(jpe?g|doc|docx|xls|xlsx|pdf)$/i,
		  sequentialUploads: true,
		  autoUpload :true
		});
		
	$('#'+file_divid_update).fileupload({
		  url: upload_link,
		  maxNumberOfFiles: 5,
		  maxFileSize : 5242880,
		  acceptFileTypes :/(\.|\/)(jpe?g|doc|docx|xls|xlsx|pdf)$/i,
		  sequentialUploads: true,
		  autoUpload :true
		});	
		

		
$(document).on('click','#add_transport_info',function(){
	
	var file_name = '';
	$('#image_file').val('');
	$('.table-striped tr').each(function() {
	var image_files = $(this).find('td p a').text(); 
	if(image_files!='')
	{  
		if (file_name == '') {
				file_name += image_files;
		}else{
				file_name += ',' + image_files; 
		}
	}
	});
	$('#image_file').val(file_name);
	
	if($('#additional-comments').val() == "" && $('#image_file').val() == "") {
		alert("Please enter comments/upload files.");
		return false;
	} else {
		//$('#add_transport_info').hide();
		if($.browser.msie) {
				$('.display_loader').html('<img id="loadimg" src="<?php echo base_url(); ?>assets/img/ajax-loading.gif" alt="loader" />');
			}
		$('.display_loader').show();
		
		$('#loadimg_mail').show();
		$('#add-additional-info').modal('hide');
		
		if($.browser.msie) {
			$('.display_loader').html('<div id="loader" style="display: none;"><img src="<?php echo base_url(); ?>assets/img/ajax-modal-loading.gif" width="32" height="32" align="absmiddle">&nbsp;<span id="loadertext">Loading...</span></div>');
		}
		
		$('.display_loader').show();
		$('#loader').show();
		
		
		//$('#transport_add_info').submit();
		
		$.ajax({
				  type: "POST",
				  url: base_url+'org_transportation/add_transport_info',
				  data: {
					  additional_comments : $('#additional-comments').val(),
					  image_file: $('#image_file').val(),
				      transport_id_add_info: $('#transport_id_add_info').val()					   
				  },
				  dataType:"json",
				  success:function(data) {
					 //alert(data);
					 $('#loader').hide();
					 $('#success_transport_info_popup').modal('show');					
				  }
			});
	}
	});   

$(document).on('click','#update_transport_info',function(){
	
	var file_name = '';
	$('#image_file_update').val('');
	$('.table-striped tr').each(function() {
	var image_files = $(this).find('td p a').text(); 
	if(image_files!='')
	{  
		if (file_name == '') {
				file_name += image_files;
		}else{
				file_name += ',' + image_files; 
		}
	}
	});
	$('#image_file_update').val(file_name);
	
	if($('#additional-comments-update').val() == "" && $('#image_file_update').val() == "" && $('#transport_info_files_cnt').val() == 0) {
		alert("Please enter comments/upload files.");
		return false;
	} else {
		//$('#update_transport_info').hide();
		
		if($.browser.msie) {
				$('.display_loader').html('<img id="loadimg" src="'+base_url+'assets/img/ajax-loading.gif" alt="loader" />');
			}
		$('.display_loader').show();
		
		$('#loadimg_mail').show();
		$('#edit-additional-info').modal('hide');
		
		if($.browser.msie) {
			$('.display_loader').html('<div id="loader" style="display: none;"><img src="'+base_url+'assets/img/ajax-modal-loading.gif" width="32" height="32" align="absmiddle">&nbsp;<span id="loadertext">Loading...</span></div>');
		}
		
		$('.display_loader').show();
		$('#loader').show();	

		//$('#transport_update_info').submit();
		$.ajax({
				  type: "POST",
				  url: base_url+'org_transportation/update_transport_info',
				  data: {
					  additional_comments_update : $('#additional-comments-update').val(),
					  image_file_update: $('#image_file_update').val(),
				      transport_id_update_info: $('#transport_id_update_info').val()					   
				  },
				  dataType:"json",
				  success:function(data) {
					 //alert(data);
					 $('#loader').hide();
					 $('#success_transport_info_popup').modal('show');
				  }
			});
	}
	});   

	//console.log(myArray);
$(document).on('click', '#add_leg_g', function(){ 
	$("#aviation_display").hide();
	$("#overnight_display").hide();
	$("#route_type").val("Road");
	$("#route_type_id").val("0");
	
		$.ajax({
					method: "POST",
					dataType: "json",
				  	url: base_url+'org_transportation/get_last_meeting_location',
				    async:false,
				data:{
	            	leg:'route'
	            },
				  success:function(data) 
				  {
				  	if(data!='')
					{		
						//console.log(data);
						$('#meeting_location_from_driver').val(data.st_to_meeting_location);
						$('#pickup_street').val(data.st_street);
						$('#pickup_location').val(data.st_zip+', '+data.st_city+', '+data.st_state+', '+data.st_country);
						$('#clockface_2_modal').val(data.dt_start_time);
						$('#clockface_2_modal_year').val(data.dt_start_year);
						$("#pickup_country").val(data.st_country);
						$("#pickup_city").val(data.st_city);
						$("#pickup_state").val(data.st_state);
						$("#pickup_zip").val(data.st_zip);
						from_date_setup = data.dt_start_time;
					}
				  }
			});
	
	$("#address_display").modal('show');
	
});

$(document).on('click', '#add_leg_a', function(){ 
	$("#overnight_display").hide();
	$("#address_display").hide();
	$("#route_type").val("Aviation");
	$("#route_type_id").val("1");
	
		$.ajax({
				method: "POST",
				dataType: "json",
				  url: base_url+'org_transportation/get_last_meeting_location',
				  async:false,	
				  data:{
	            	leg:'aviation'
	            },		
				  success:function(data) 
				  {
				  	//console.log(data);
					if(data!='')
					{
						$('#meeting_location_from_pilot').val(data.st_to_meeting_location);						
						$("#pickup_airport").val(data.st_street);
						$("#pickup_airport_city").val(data.st_city);
						$("#pickup_airport_state").val(data.st_state);

						$('#pickup_location').val(data.st_zip+', '+data.st_city+', '+data.st_state+', '+data.st_country);
						$('#pickup_airport_clock').val(data.dt_start_time);
						$('#pickup_airport_clock_year').val(data.dt_start_year);
						$("#pickup_country").val(data.st_country);
					
						$("#pickup_zip").val(data.st_zip);
						from_date_setup = data.dt_start_time;
					}
				  }
			});
	
	//$("#aviation_display").toggle();
	$("#aviation_display").modal('show');	
});

$(document).on('click', '#add_leg_o', function(){ 
	$("#aviation_display").hide();			
	$("#address_display").hide();
	$("#route_type").val("Overnight");
	$("#route_type_id").val("2");
	
	$.ajax({
				type: "POST",
				  url: base_url+'org_transportation/get_last_meeting_location',
				  async:false,
				  success:function(data) 
				  {
					if(data!='')
					{
						$('#overnight_comments').html(data);
					}
				  }
			});
	
	$("#overnight_display").modal('show');
	//$("#overnight_display").toggle();
});

jQuery(document).ready(function() 
{
    $('#addlegs').validate({
		errorElement: 'span', //default input error message container
		errorClass: 'help-block', // default input error message class
		focusInvalid: true, // do not focus the last invalid input
		rules: {
			/*pickup_city: {
				required: true
			},
			pickup_state: {
				required: true
			},
			pickup_zip: {
				required: true
			},*/
			/*dropoff_city: {
				required: true
			},
			dropoff_state: {
				required: true
			},
			dropoff_zip: {
				required: true
			},*/
			pickup_zone: {
				required: true
			},
			clockface_2_modal: {
				required: true
			},
			dropoff_zone: {
				required: true
			},
			clockface_3_modal: {
				required: true
			},
			pickup_airport: {
				required: true
			},
			pickup_airport_clock: {
				required: true
			},
			pickup_airport_zone: {
				required: true
			},
			dropoff_airport: {
				required: true
			},
			dropoff_airport_clock: {
				required: true
			},
			dropoff_airport_zone: {
				required: true
			},
			dropoff_location: {
				required: true
			},
			pickup_location: {
				required: true
			},
			o_pickup_location: {
				required: true
			},
			pick_base_airport:{
				required: true
			},
			drop_base_airport:{
				required: true
			},
			pickup_airline_clock: {
				required: true
			},
			dropoff_airline_clock: {
				required: true
			},
			pickup_airline_zone:{
				required: true
			},
			dropoff_airline_zone:{
				required: true
			},
			no_of_drivers: {
				required: {
						depends: function(){
								if($('#multiple_drivers_txt').val() == '1'){ 
									return true;
								} else {
									return false;
								}
							}
						}
			},
			no_of_pilots: {
				required: {
						depends: function(){
								if($('#multiple_pilots_txt').val() == '1'){ 
									return true;
								} else {
									return false;
								}
							}
						}
			},
			o_pickup_city: {
				required: {
						depends: function(){
								if($('#route_type_id').val() == '2'){ 
									return true;
								} else {
									return false;
								}
							}
						}
			},
			o_pickup_state: {
				required: {
						depends: function(){
								if($('#route_type_id').val() == '2'){ 
									return true;
								} else {
									return false;
								}
							}
						}
			},
			o_pickup_country: {
				required: {
						depends: function(){
								if($('#route_type_id').val() == '2'){ 
									return true;
								} else {
									return false;
								}
							}
						}
			},
			o_pickup_zip: {
				required: {
						depends: function(){
								if($('#route_type_id').val() == '2'){ 
									return true;
								} else {
									return false;
								}
							}
						}
			}
			
			
			},

		messages: {
			/*pickup_city: {
				required: 'Please enter pick up city.'
			},
			pickup_state: {
				required: 'Please enter pick up state.'
			},
			pickup_zip: {
				required: 'Please enter pick up zip.'
			},
			dropoff_city: {
				required: 'Please enter drop off city.'
			},
			dropoff_state: {
				required: 'Please enter drop off state.'
			},
			dropoff_zip: {
				required: 'Please enter drop off zip.'
			},*/
			pickup_zone: {
				required: 'Please select pick up time zone.'
			},
			clockface_2_modal: {
				required: "Please select start time."
			},
			dropoff_zone: {
				required: 'Please select pick up time zone.'
			},
			clockface_3_modal: {
				required: "Please select end time."
			},
			pickup_airport: {
				required: "Please enter from location."
			},
			pickup_airport_clock: {
				required: "Please select start time."
			},
			pickup_airport_zone: {
				required: "Please select pick up time zone."
			},
			dropoff_airport: {
				required: "Please enter to location."
			},
			dropoff_airport_clock: {
				required: "Please select end time."
			},
			dropoff_airport_zone: {
				required: "Please select drop off time zone."
			},
			no_of_drivers: {
				required: "Please select number of drivers."
			},
			no_of_pilots: {
				required: "Please select number of pilots."
			},
			o_pickup_city: {
				required: "Please enter city."
			},
			o_pickup_state: {
				required: "Please select state."
			},
			o_pickup_country: {
				required: "Please select country."
			},
			o_pickup_zip: {
				required: "Please enter zipcode."
			},
			pickup_location:{
				required :"Please enter pickup location"
			},
			dropoff_location:{
				required :"Please enter dropoff location"
			},
			o_pickup_location:{
				required :"Please enter overnight location"
			},
			pick_base_airport: {
				required: "Please enter from location."
			},
			pickup_airline_clock: {
				required: "Please select start time."
			},
			pickup_airline_zone: {
				required: "Please select pick up time zone."
			},
			drop_base_airport: {
				required: "Please enter to location."
			},
			dropoff_airline_clock: {
				required: "Please select end time."
			},
			dropoff_airline_zone: {
				required: "Please select drop off time zone."
			},
		},

		invalidHandler: function (event, validator) { //display error alert on form submit   
			$('#addlegs').show();
			
			var errors = validator.numberOfInvalids();
			if (errors) {
			  var message = errors == 1
				? 'You missed 1 field. It has been highlighted'
				: 'You missed ' + errors + ' fields. They have been highlighted';
			  alert(message);
			}
		},

		highlight: function (element) { // hightlight error inputs
			$(element)
				.closest('.form-group').addClass('has-error'); // set error class to the control group
		},

		success: function (label) { //alert(label);
			label.closest('.form-group').removeClass('has-error');
			label.remove();
		},

		errorPlacement: function (error, element) { 
			if (element.attr("name") == "clockface_2_modal" || element.attr("name") == "clockface_3_modal" || element.attr("name") == "pickup_airport_clock" || element.attr("name") == "dropoff_airport_clock" || element.attr("name") == "pickup_airline_clock" || element.attr("name") == "dropoff_airline_clock")
			{
				error.addClass('help-block').insertAfter(element.closest('.input-group'));
			}
			else
			{
				error.addClass('help-block').insertAfter(element.closest('.form-control'));
			}
		}

	});
});	

function renumber_table(tableID) 
{
    $(tableID + " tr").each(function() {
		//alert(this.id);
		var mystr = this.id;
		var leg_id = $(this).attr('data-leg-id');
		//alert(leg_id);
		var prev_pos = $(this).attr('data-sort-order');
		
		//var prev_pos = mystr.substr(mystr.indexOf("_") + 1);
        
		count = $(this).parent().children().index($(this)) + 1;
		var curr_pos = count;
		var multi_driver_icon = '';
		if ($(this).find('span.leg-fa-users').length)
		{
			multi_driver_icon = '<span class=\"leg-fa-users\"><i class=\"fa fa-users\"></i></span>';
		}
        //$(this).find('.priority').html('<span class="glyphicon glyphicon-move"></span> '+count+'.'+multi_driver_icon);
		 $(this).find('.priority').html('<i class="material-icons">zoom_out_map</i> '+count+' '+multi_driver_icon);
        //$(this).find('.priority').html('<span class="glyphicon glyphicon-move"></span> '+count+'.');
		//alert('prev position: '+prev_pos);
		//alert('curr position: '+curr_pos);
		this.id = 'tr_'+count;
		
		for(var i=0;i<myArray.length;i++)
		{
			if(myArray[i]['update_leg']['leg_id']!='')
			{	
				if(leg_id == myArray[i]['leg_id'])
				{	
					if(myArray[i]['update_leg'] != 'delete')
					{
						myArray[i]['in_sort_order'] = count;	
					}		
				}
			}	
		}
		//console.log(myArray);
		
			
    });
	
}


$(document).ready(function(){
  
$("body").tooltip({ selector: '[data-toggle="tooltip"]' });


var fixHelperModified = function(e, tr) {
	var $originals = tr.children();
	var $helper = tr.clone();
	return $helper;
};

$("#card-table tbody").sortable({
	handle: '.priority',
	helper: fixHelperModified,
	stop: function(event,ui) {
		renumber_table('#leg_table_body')
		var jsondata = JSON.stringify(myArray);
			$.ajax({
				url: base_url+'org_transportation/update_sort_order_legs/',
				type: 'POST',
					beforeSend: function() {
					$('#legs_reorder').modal('show');
				  },
				data: { data_val:jsondata},
				success: function(result) {
					//console.log(result);
				},
				complete: function() {
					 $('#legs_reorder').modal('hide');
				  },
			});
		}
}).disableSelection();

});

$(document).on('click','#submit',function(){	

	if( $('#addlegs').valid() == false) {
		return false;
	} else {
		
	  var to_date = $('#clockface_3_modal').val();
	  var from_date = $('#clockface_2_modal').val();
	  var to_date_split = to_date.split('-');
	  var from_date_split = from_date.split('-');
	  var frm_year = $('#clockface_2_modal_year').val();
	  var to_year = $('#clockface_3_modal_year').val();
	  var start_time_date = new Date(from_date_split[0]+frm_year);
	  var end_time_date = new Date(to_date_split[0]+to_year);
	  
	  var end_date = new Date(end_time_date.getFullYear(), end_time_date.getMonth(), end_time_date.getDate()); 
	  var start_date = new Date(start_time_date.getFullYear(), start_time_date.getMonth(), start_time_date.getDate()); 
	  
	  if (start_date > end_date) {
			alert("Start Date is greather than End Date.");
			return false;
	  } 
	  if (end_date < start_date) {
			alert("End Date is less than Start Date.");
			return false;
	  }
	  //var valid_legs =  $('#addlegs').valid() ;
	  $("#address_display").modal('toggle');
	  $('#transportleg_loader').modal('toggle');
	  
	  if(edit_q!='')
		{
			edit_sort_order = myArray[edit_q-1].in_sort_order;	
			delete myArray[edit_q-1];	
		}
	  
		
		var pickup_address  = ($("#pickup_street").val()?$("#pickup_street").val()+", ":"");
			pickup_address += ($("#pickup_city").val()?$("#pickup_city").val()+", ":"");
			pickup_address += ($("#pickup_state").val()?$("#pickup_state").val():"");
			pickup_address += ($("#pickup_zip").val()?", "+$("#pickup_zip").val():"");
			
		var dropoff_address  = ($("#dropoff_street").val()?$("#dropoff_street").val()+", ":"");
			dropoff_address += ($("#dropoff_city").val()?$("#dropoff_city").val()+", ":"");
			dropoff_address += ($("#dropoff_state").val()?$("#dropoff_state").val():"");
			dropoff_address += ($("#dropoff_zip").val()?", "+$("#dropoff_zip").val():"");
		
		if($('#pre-assign_volunteer-driver').length > 0)
		{	
			var volunteer_name = $('#pre-assign_volunteer-driver').val().replace(/\s/g,'');
		} else {
			var volunteer_name = '' ;
		}
		
		if($('#pre-assign_volunteer-driver-id').length > 0)
		{	
				var user_id = $('#pre-assign_volunteer-driver-id').val();
		} else {
				var user_id = '0' ;
		}
			
		if($('#deleteuid-driver1').length > 0)
		{	
				var deleted_user_id = $('#deleteuid-driver1').val();
		} else {
				var deleted_user_id = '0' ;
		}
			
		if($('#non-doobert-userid').length > 0)
		{	
				var non_doobert_userid = $('#non-doobert-userid').val();
		} else {
				var non_doobert_userid = '0' ;
		}
			
		var start_time 		 = $("#clockface_2_modal").val();	
			start_time 		+= " - "+$("#pickup_zone").val();	
		var end_time 		 = $("#clockface_3_modal").val();	
			end_time 		+= " - "+$("#dropoff_zone").val();
	
		var leg_id 			= $("#leg_id").val();	
		var update_leg 		= "update";		
	    var b;	
		
		var pick_dropoff    = pickup_address+'<i class="material-icons">keyboard_backspace</i>'+dropoff_address; 	
		var start_end_time = start_time+'<br>'+end_time;	
		
		var meeting_location = $("#meeting_location_from_driver").val();
		
		var no_of_drivers = $("#no_of_drivers").val();
		
		legsArray = [];
		if(edit_q!='')
		{
			var i 		= edit_q-1;
			var index 	= edit_q;	
			//var user_id = $('#pre-assign_volunteer-driver-id').val();
			var sort_order = index;
			
			if(myArray[i-1])
			{
				if(typeof myArray[i-1].in_sort_order === 'undefined')
				{
					sort_order = 1;				
				}else{
					sort_order = parseInt(myArray[i-1].in_sort_order) + parseInt(1);
					}
			}

			var sort_order_max = parseInt(edit_sort_order) + parseInt(1);
			var order_id = edit_sort_order;
			var c=[];
		    if(sort_order_max > 0)
			{	
				var counter= 0;	
				var count_loop=1;
				do {
					var inc_counter='0';	
					for(var k=0; k<myArray.length;++k)
					{
						inc_counter++;
						if(i != k)
						{	
							var value = myArray[k];
							if(myArray[k].update_leg !='delete')
							{
								if(sort_order_max == value.in_sort_order && value.route_type_id == '2' )
								{		
									sort_order_max = parseInt(sort_order_max) + parseInt(1);
									c[counter] = k;
									counter++;
									count_loop=1;
									break;
								
								} else if(sort_order_max == value.in_sort_order && value.route_type_id != '2' )
								{	
									c[counter] = k;
									counter++;
									count_loop=0;
									break;
								} else {
									next_counter_value = $.map(myArray, function( value, index ) {
														    if(index != i)
															{	
															   if(sort_order_max == value.in_sort_order && value.update_leg !='delete')
														    	return index;
															}	
														});
									 if(next_counter_value.length >0)
									 {
										 count_loop=1;
									 } else {
										 count_loop=0;
										 break;
									 }
								}
							}
						} else if(inc_counter == myArray.length ){
							count_loop=0;
						}		
					}
				} while(count_loop!=0)		
				if(c.length >0)
				{		
					//b =	b[0];
				}	
				else 
				c = -1;
			} else {
				c = -1;
			}
			
			
         	myArray[i]=({"pickup_street":addslashes($("#pickup_street").val()),"pickup_city":addslashes($("#pickup_city").val()),"pickup_state":addslashes($("#pickup_state").val()),"pickup_zip":addslashes($("#pickup_zip").val()),"pickup_country":addslashes($("#pickup_country").val()),"clockface_2_modal":$("#clockface_2_modal").val(),"pickup_zone":$("#pickup_zone").val(),"dropoff_street":addslashes($("#dropoff_street").val()),"dropoff_city":addslashes($("#dropoff_city").val()),"dropoff_state":addslashes($("#dropoff_state").val()),"dropoff_zip":addslashes($("#dropoff_zip").val()),"dropoff_country":addslashes($("#dropoff_country").val()),"clockface_3_modal":$("#clockface_3_modal").val(),"dropoff_zone":$("#dropoff_zone").val(),"leg_id":$("#leg_id").val(),"route_type":$("#route_type").val(),"route_type_id":$("#route_type_id").val(),"pickup_airport":addslashes($("#pickup_airport").val()),"pickup_airport_clock":$("#pickup_airport_clock").val(),"pickup_airport_zone":$("#pickup_airport_zone").val(),"dropoff_airport":addslashes($("#dropoff_airport").val()),"dropoff_airport_clock":$("#dropoff_airport_clock").val(),"dropoff_airport_zone":$("#dropoff_airport_zone").val(),"dropoff_airport_state":addslashes($("#dropoff_airport_state").val()),"dropoff_airport_city":addslashes($("#dropoff_airport_city").val()),"pickup_airport_state":addslashes($("#pickup_airport_state").val()),"pickup_airport_city":addslashes($("#pickup_airport_city").val()),"update_leg":"update","meeting_location":addslashes($("#meeting_location_from_driver").val()),"no_of_drivers":addslashes($("#no_of_drivers").val()),"multiple_drivers":addslashes($("#multiple_drivers_txt").val()),"in_sort_order":edit_sort_order,leg_instruction:addslashes($("#leg_instructions").val()),'to_meeting_location':addslashes($('#meeting_location_to_driver').val()),'pick_year':addslashes($('#clockface_2_modal_year').val()),'drop_year':addslashes($('#clockface_3_modal_year').val())});
			legsArray[0] =({"pickup_street":addslashes($("#pickup_street").val()),"pickup_city":addslashes($("#pickup_city").val()),"pickup_state":addslashes($("#pickup_state").val()),"pickup_zip":addslashes($("#pickup_zip").val()),"pickup_country":addslashes($("#pickup_country").val()),"clockface_2_modal":$("#clockface_2_modal").val(),"pickup_zone":$("#pickup_zone").val(),"dropoff_street":addslashes($("#dropoff_street").val()),"dropoff_city":addslashes($("#dropoff_city").val()),"dropoff_state":addslashes($("#dropoff_state").val()),"dropoff_zip":addslashes($("#dropoff_zip").val()),"dropoff_country":addslashes($("#dropoff_country").val()),"clockface_3_modal":$("#clockface_3_modal").val(),"dropoff_zone":$("#dropoff_zone").val(),"leg_id":$("#leg_id").val(),"route_type":$("#route_type").val(),"route_type_id":$("#route_type_id").val(),"pickup_airport":addslashes($("#pickup_airport").val()),"pickup_airport_clock":$("#pickup_airport_clock").val(),"pickup_airport_zone":$("#pickup_airport_zone").val(),"dropoff_airport":addslashes($("#dropoff_airport").val()),"dropoff_airport_clock":$("#dropoff_airport_clock").val(),"dropoff_airport_zone":$("#dropoff_airport_zone").val(),"dropoff_airport_state":addslashes($("#dropoff_airport_state").val()),"dropoff_airport_city":addslashes($("#dropoff_airport_city").val()),"pickup_airport_state":addslashes($("#pickup_airport_state").val()),"pickup_airport_city":addslashes($("#pickup_airport_city").val()),"update_leg":"update","meeting_location":addslashes($("#meeting_location_from_driver").val()),"no_of_drivers":addslashes($("#no_of_drivers").val()),"multiple_drivers":addslashes($("#multiple_drivers_txt").val()),"in_sort_order":edit_sort_order,leg_instruction:addslashes($("#leg_instructions").val()),'to_meeting_location':addslashes($('#meeting_location_to_driver').val()),'user_id':addslashes(user_id),'deleted_user_id':addslashes(deleted_user_id),'non_doobert_userid':addslashes(non_doobert_userid),'volunteer_name':addslashes(volunteer_name),'pick_year':addslashes($('#clockface_2_modal_year').val()),'drop_year':addslashes($('#clockface_3_modal_year').val())});
	
			/*if(c.length >0)
			{
				var k=0;
				for(var j=0;j<c.length;j++ )
				{
					b=c[j];
					if(myArray[b].route_type_id == '0')
					{
						myArray[b].pickup_street = addslashes($("#dropoff_street").val());
						myArray[b].pickup_city = addslashes($("#dropoff_city").val());
						myArray[b].pickup_state = addslashes($("#dropoff_state").val());
						myArray[b].pickup_zip = addslashes($("#dropoff_zip").val());
						myArray[b].pickup_country = addslashes($("#dropoff_country").val());
					} else if(myArray[b].route_type_id == '1')
					{
						var term = $("#dropoff_zip").val();
						$.ajax({
						url: base_url+"org_transportation/get_airports_by_zipcode_or_airport_id/" ,
						dataType: "json",
						async:false,
						data:{
						term:term 
						},
						success: function (data)
						{
							//console.log(data[0]);
							myArray[b].pickup_street = data[0].value;
							myArray[b].pickup_airport = data[0].value;
							myArray[b].pickup_airport_state = data[0].st_state;
							myArray[b].pickup_airport_city = data[0].st_city;
							myArray[b].pickup_city    = data[0].st_city;
							myArray[b].pickup_state   = data[0].st_state;
							//$("#pickup_airport").val(data[0].value);
							//$("#pickup_airport_city").val(stripslashes(data[0].st_city));
							//$("#pickup_airport_state").val(stripslashes(data[0].st_state));	
						},
					});
					
					myArray[b].pickup_zip         = '';
					myArray[b].pickup_country     = '';
					} else if(myArray[b].route_type_id == '2') {
					
					myArray[b].o_pickup_street = addslashes($("#dropoff_street").val());
					myArray[b].o_pickup_city = addslashes($("#dropoff_city").val());
					myArray[b].o_pickup_state = addslashes($("#dropoff_state").val());
					myArray[b].o_pickup_zip = addslashes($("#dropoff_zip").val());
					myArray[b].o_pickup_country = addslashes($("#dropoff_country").val());
				}
				k = parseInt(k) + parseInt(1);
				legsArray[k] = myArray[b];
			  }		
			}*/
			
		}
		else
		{
			q++;
			var index = q;
			c = -1;
			var sort_order = index;
			
			var sort_order = index;
			
				if(myArray.length == 0)	
				{
					
					sort_order = 1;				
				}else{
					  var get_sort_order = $.map( myArray, function( value, index ) {
											return value.in_sort_order;
								});
					  
					  	if(get_sort_order.length > 0)
								{	
									var max_order_value	 = 	Math.max.apply(Math,get_sort_order);
								} else {
									var max_order_value	 = 	0;		
								}
					 sort_order = parseInt(max_order_value) + parseInt(1);			
					
				}					
		
			var order_id = sort_order;
			//var user_id = $('#pre-assign_volunteer-driver-id').val();
		
			
			   myArray.push({"pickup_street":addslashes($("#pickup_street").val()),"pickup_city":addslashes($("#pickup_city").val()),"pickup_state":addslashes($("#pickup_state").val()),"pickup_zip":addslashes($("#pickup_zip").val()),"pickup_country":addslashes($("#pickup_country").val()),"clockface_2_modal":$("#clockface_2_modal").val(),"pickup_zone":$("#pickup_zone").val(),"dropoff_street":addslashes($("#dropoff_street").val()),"dropoff_city":addslashes($("#dropoff_city").val()),"dropoff_state":addslashes($("#dropoff_state").val()),"dropoff_zip":addslashes($("#dropoff_zip").val()),"dropoff_country":addslashes($("#dropoff_country").val()),"clockface_3_modal":$("#clockface_3_modal").val(),"dropoff_zone":$("#dropoff_zone").val(),"leg_id":$("#leg_id").val(),"route_type":$("#route_type").val(),"route_type_id":$("#route_type_id").val(),"pickup_airport":addslashes($("#pickup_airport").val()),"pickup_airport_clock":$("#pickup_airport_clock").val(),"pickup_airport_zone":$("#pickup_airport_zone").val(),"dropoff_airport":addslashes($("#dropoff_airport").val()),"dropoff_airport_clock":$("#dropoff_airport_clock").val(),"dropoff_airport_zone":$("#dropoff_airport_zone").val(),"dropoff_airport_state":addslashes($("#dropoff_airport_state").val()),"dropoff_airport_city":addslashes($("#dropoff_airport_city").val()),"pickup_airport_state":addslashes($("#pickup_airport_state").val()),"pickup_airport_city":addslashes($("#pickup_airport_city").val()),"update_leg":"update","meeting_location":addslashes($("#meeting_location_from_driver").val()),"no_of_drivers":$("#no_of_drivers").val(),"multiple_drivers":addslashes($("#multiple_drivers_txt").val()),"in_sort_order":sort_order,leg_instruction:addslashes($("#leg_instructions").val()),'to_meeting_location':addslashes($('#meeting_location_to_driver').val()),'pick_year':addslashes($('#clockface_2_modal_year').val()),'drop_year':addslashes($('#clockface_3_modal_year').val())});
			   legsArray[0] = ({"pickup_street":addslashes($("#pickup_street").val()),"pickup_city":addslashes($("#pickup_city").val()),"pickup_state":addslashes($("#pickup_state").val()),"pickup_zip":addslashes($("#pickup_zip").val()),"pickup_country":addslashes($("#pickup_country").val()),"clockface_2_modal":$("#clockface_2_modal").val(),"pickup_zone":$("#pickup_zone").val(),"dropoff_street":addslashes($("#dropoff_street").val()),"dropoff_city":addslashes($("#dropoff_city").val()),"dropoff_state":addslashes($("#dropoff_state").val()),"dropoff_zip":addslashes($("#dropoff_zip").val()),"dropoff_country":addslashes($("#dropoff_country").val()),"clockface_3_modal":$("#clockface_3_modal").val(),"dropoff_zone":$("#dropoff_zone").val(),"leg_id":$("#leg_id").val(),"route_type":$("#route_type").val(),"route_type_id":$("#route_type_id").val(),"pickup_airport":addslashes($("#pickup_airport").val()),"pickup_airport_clock":$("#pickup_airport_clock").val(),"pickup_airport_zone":$("#pickup_airport_zone").val(),"dropoff_airport":addslashes($("#dropoff_airport").val()),"dropoff_airport_clock":$("#dropoff_airport_clock").val(),"dropoff_airport_zone":$("#dropoff_airport_zone").val(),"dropoff_airport_state":addslashes($("#dropoff_airport_state").val()),"dropoff_airport_city":addslashes($("#dropoff_airport_city").val()),"pickup_airport_state":addslashes($("#pickup_airport_state").val()),"pickup_airport_city":addslashes($("#pickup_airport_city").val()),"update_leg":"update","meeting_location":addslashes($("#meeting_location_from_driver").val()),"no_of_drivers":$("#no_of_drivers").val(),"multiple_drivers":addslashes($("#multiple_drivers_txt").val()),"in_sort_order":sort_order,leg_instruction:addslashes($("#leg_instructions").val()),'to_meeting_location':addslashes($('#meeting_location_to_driver').val()),'user_id':addslashes(user_id),'deleted_user_id':addslashes(deleted_user_id),'non_doobert_userid':addslashes(non_doobert_userid),'volunteer_name':addslashes(volunteer_name),'pick_year':addslashes($('#clockface_2_modal_year').val()),'drop_year':addslashes($('#clockface_3_modal_year').val())});
		}
			legsArray = JSON.stringify(legsArray);
			
			
	        /*	jQuery.post(base_url+"org_transportation/create_legs/"+transport_id+"/",{legsArray:legsArray,action:"save_legs"}, function( data ) {	
			});*/	
			
				$.ajax({ 
					type:'POST',
					url:base_url+"org_transportation/create_legs/"+transport_id+"/",
					async:false,
					data:{
						legsArray:legsArray,
						action:"save_legs"
					}, 
					success:function(data) 
					{
						if(user_id == 'n-d-u')
							{
								$('#non_doobert_user_transport_leg_id').val(data);
							}
					},	
				});	
			if(user_id == 'n-d-u')
			{
				$('#assign-nondoobert-user').modal('show');
			} else {	
			var cname = 'edit_legs';
			var cvalue = '1';
			var exdays = '1';
			var d = new Date();
			d.setTime(d.getTime() + (exdays*24*60*60*1000));
			var expires = "expires="+ d.toUTCString();
			document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;domain=.doobert.com";
			window.location = base_url+'transport-create-legs/';				
			}
			 			
		
	}
});

$('#pickup_location').autocomplete({
	
	source: function (request, response)
    {
		request.term = $.trim(request.term);
		var str	= request.term;
		var letters = /^[a-zA-Z ]+$/;	
		if(str.match(letters))
		{
			request.term = str; 
		} else {
			str = str.toUpperCase();
			request.term = str.replace(/\s/g, ''); 
		}	
        $.ajax(
        {
            url: base_url+"org_transportation/get_zip_code2/" ,
            dataType: "json",
            data:
            {
                term: request.term,
				city: $("#pick_city" ).val(),
				state: $("#pick_state" ).val()
            },
            success: function (data)
            {
				//console.log(data);
				if(data=="1")
				{
					window.location.href=base_url;
				}
				else
				{
                	response(data);
				}
            }
        });
    },
	minLength:1,
	open: function() { $('.ui-menu').width($("#pickup_location" ).width())},
	focus: function( event, ui ) {
			var id = ui.item.label;
			var name = ui.item.value;
			$("#pickup_location" ).val(name);
			$("#pickup_country" ).val(ui.item.st_country);
			$("#pickup_city" ).val(ui.item.city);
			$("#pickup_state" ).val(ui.item.state_prefix);
			$("#pickup_zip").val(name);
			return false;
	},     
	select: function( event, ui ) {
		var id = ui.item.label;
		var name = ui.item.value;
		//$("#pick_zip" ).val(name);
		$("#pickup_location" ).val(id);
		$("#pickup_country" ).val(ui.item.st_country);
		//country_state(ui.item.st_country,"pick");
		$("#pickup_city" ).val(ui.item.city);
		$("#pickup_state" ).val(ui.item.state_prefix);
		$("#pickup_zip").val(name);
		
		return false;
	}
	});
	
$(document).on('change','#pickup_location',function(){
//var selected_zipcode = $(this).val();
var selected_zipcode = $.trim($(this).val());
var str	= selected_zipcode; 
//selected_zipcode = str.replace(/\s/g, '');  

var letters = /^[a-zA-Z ]+$/;	
if(str.match(letters))
{
			 selected_zipcode = str; 
} else {
			 str = str.toUpperCase();  	
			 selected_zipcode = str.replace(/\s/g, ''); 
}

//alert(selected_zipcode);
//alert($("#pick_city" ).val());
var select_pickup_city = $("#pickup_city" ).val();
//alert(select_pickup_city);
var select_pickup_state = $("#pickup_state" ).val();
//alert(select_pickup_state);
var select_pickup_country = $("#pickup_country" ).val();
//alert(select_pickup_country);
//alert($("#pick_zip").val());
//alert($("#pick_zip").val().indexOf(','));

if ($("#pickup_location").val().indexOf(',') != -1 && $("#pickup_location").val().indexOf('USA') != -1 && $("#pickup_location").val().indexOf('Canada') != -1) {
	if(selected_zipcode != '' && select_pickup_city != '' && select_pickup_state != '' && select_pickup_country != '')
	{
		$("#pickup_location").val(selected_zipcode+', '+select_pickup_city+', '+select_pickup_state+', '+select_pickup_country);
	}
}
else
{
	if(selected_zipcode!=''){
	  $.ajax({
            url: base_url+"org_transportation/get_zip_code2/" ,
            dataType: "json",
            data:
            {
                term: selected_zipcode,
				city: $("#pickup_city" ).val(),
				state: $("#pickup_state" ).val()
            },
            success: function (data)
            {
				if(data)
				{
					$("#pickup_location").val(data[0].label);
					$("#pickup_country" ).val(data[0].st_country);
					$("#pickup_city" ).val(data[0].city);
					$("#pickup_state" ).val(data[0].state_prefix);
					$("#pickup_zip").val(data[0].value);
				}
				else
				{
					if($("#pickup_location").val().indexOf(',') == -1)
					{
						alert('Please enter valid pickup location');
						$("#pickup_location").val('');
					}
				}
				
            }
        });
	}//!=''		
}
});

$('#dropoff_location').autocomplete({
	//source:"<?php echo base_url(); ?>org_transportation/get_zip_code/", 
	source: function (request, response)
    {
		request.term = $.trim(request.term);
		var str	= request.term;
		var letters = /^[a-zA-Z ]+$/;	
		if(str.match(letters))
		{
			request.term = str; 
		} else {
			str = str.toUpperCase();
			request.term = str.replace(/\s/g, ''); 
		}	
        $.ajax(
        {
            url: base_url+"org_transportation/get_zip_code2/" ,
            dataType: "json",
            data:
            {
                term: request.term,
				city: $("#dropoff_city" ).val(),
				state: $("#dropoff_state" ).val()
            },
            success: function (data)
            {
				//console.log(data);
				if(data=="1")
				{
					window.location.href=base_url;
				}
				else
				{
                	response(data);
				}
            }
        });
    },
	minLength:1,
	open: function() { $('.ui-menu').width($("#dropoff_location" ).width())},
	focus: function( event, ui ) {
			var id = ui.item.label;
			var name = ui.item.value;
			$("#dropoff_location" ).val(name);
			$("#dropoff_country" ).val(ui.item.st_country);
			//country_state(ui.item.st_country,"pick");
			$("#dropoff_city" ).val(ui.item.city);
			$("#dropoff_state" ).val(ui.item.state_prefix);
			$("#dropoff_zip").val(name);
			//alert('value replace');
			return false;
	},     
	select: function( event, ui ) {
		//alert('in select');
		var id = ui.item.label;
		var name = ui.item.value;
		//$("#pick_zip" ).val(name);
		$("#dropoff_location" ).val(id);
		$("#dropoff_country" ).val(ui.item.st_country);
		//country_state(ui.item.st_country,"pick");
		$("#dropoff_city" ).val(ui.item.city);
		$("#dropoff_state" ).val(ui.item.state_prefix);
		$("#dropoff_zip").val(name);
		
		return false;
	}
	});
	
$(document).on('change','#dropoff_location',function(){
//var selected_zipcode = $(this).val();
var selected_zipcode = $.trim($(this).val());
var str	= selected_zipcode; 
  

var letters = /^[a-zA-Z ]+$/;	
if(str.match(letters))
{
			 selected_zipcode = str; 
} else {
			 str = str.toUpperCase();  	
			 selected_zipcode = str.replace(/\s/g, ''); 
}


var select_pickup_city = $("#dropoff_city" ).val();

var select_pickup_state = $("#dropoff_state" ).val();

var select_pickup_country = $("#dropoff_country" ).val();


if ($("#dropoff_location").val().indexOf(',') != -1 && $("#dropoff_location").val().indexOf('USA') != -1 && $("#dropoff_location").val().indexOf('Canada') != -1) {
	if(selected_zipcode != '' && select_pickup_city != '' && select_pickup_state != '' && select_pickup_country != '')
	{
		$("#dropoff_location").val(selected_zipcode+', '+select_pickup_city+', '+select_pickup_state+', '+select_pickup_country);
	}
}
else
{
	if(selected_zipcode!=''){
	  $.ajax({
            url: base_url+"org_transportation/get_zip_code2/" ,
            dataType: "json",
            data:
            {
                term: selected_zipcode,
				city: $("#dropoff_city" ).val(),
				state: $("#dropoff_state" ).val()
            },
            success: function (data)
            {
				//alert(data);
				//alert(data.length);
				//console.log(data);
				//console.log(data[0].label);
				if(data)
				{
				$("#dropoff_location").val(data[0].label);
				$("#dropoff_country" ).val(data[0].st_country);
				//country_state(data[0].st_country,"drop");
				$("#dropoff_city" ).val(data[0].city);
				$("#dropoff_state" ).val(data[0].state_prefix);
				$("#dropoff_zip").val(data[0].value);
				}
				else
				{
					if($("#dropoff_location").val().indexOf(',') == -1)
					{
						alert('Please enter valid dropoff location');	
						$('#dropoff_location').val('');
					}
				}
				
            }
        });	
	}	
}
});

$('#pickup_airport').autocomplete({
		source: function (request, response)
   		 {
			request.term = $.trim(request.term);
			var str	= request.term;
			var letters = /^[a-zA-Z ]+$/;	
			if(str.match(letters))
			{
				request.term = str; 
			} else {
				str = str.toUpperCase();
				request.term = str.replace(/\s/g, ''); 
			}
			
			$.ajax(
			{
				//url: "<?php echo base_url(); ?>org_transportation/get_airports_by_zipcode/" ,
				url: base_url+"org_transportation/get_airports_by_zipcode_or_airport_id/" ,
				dataType: "json",
				data:
				{
					term: request.term
				},
				success: function (data)
				{
					//alert(data);
					//return false;
					//response(data);
					if(data=="1")
					{
						window.location.href=base_url;
					}
					/*if(data == null || data === '')
					{
						alert('Please enter valid from Zipcode/Airport ID');
						$("#pickup_airport").val('');
					}
					else*/
					if(1)
					{
						response(data);
					}
					
				}
			});
  	  	},
		minLength:1,
		open: function() { $('.ui-menu').width($("#pickup_airport" ).width()) },
		focus: function( event, ui ) {
				var id = ui.item.label;
				//alert(id);
				var name = ui.item.value;
				$( "#pickup_airport" ).val(name);
				$( "#pickup_airport_state" ).val(ui.item.st_state);
				$( "#pickup_airport_city" ).val(ui.item.st_city);
				return false;
		},     
		select: function( event, ui ) {
			var id = ui.item.label;
			var name = ui.item.value;
			$("#pickup_airport" ).val(name);
			$("#pickup_airport_state" ).val(ui.item.st_state);
			$("#pickup_airport_city" ).val(ui.item.st_city);
			return false;
		}
	});	
$(document).on('change','#pickup_airport',function(){
//var selected_zipcode = $(this).val();
var selected_zipcode = $.trim($(this).val());
var str	= selected_zipcode; 
//selected_zipcode = str.replace(/\s/g, ''); 

var letters = /^[a-zA-Z ]+$/;	
if(str.match(letters))
{
			 selected_zipcode = str; 
} else {
			 str = str.toUpperCase();  	
			 selected_zipcode = str.replace(/\s/g, ''); 
}

//alert($("#pick_city" ).val());
var select_pickup_city = $("#pickup_airport_city" ).val();
//alert(select_pickup_city);
var select_pickup_state = $("#pickup_airport_state" ).val();
//alert(select_pickup_state);
//var select_pickup_country = $("#pickup_country" ).val();
//alert(select_pickup_country);
//alert($("#pick_zip").val());
//alert($("#pick_zip").val().indexOf(','));

if ($("#pickup_airport").val().indexOf(',') != -1 && $("#pickup_airport").val().indexOf('USA') != -1 && $("#pickup_airport").val().indexOf('Canada') != -1) {
	if(selected_zipcode != '' && select_pickup_city != '' && select_pickup_state != '' && select_pickup_country != '')
	{
		//$("#pickup_location").val(selected_zipcode+', '+select_pickup_city+', '+select_pickup_state+', '+select_pickup_country);
	}
}
else
{
	if(selected_zipcode!=''){	
	  $.ajax({
            url: base_url+"org_transportation/get_airports_by_zipcode_or_airport_id/" ,
            dataType: "json",
            data:
            {
                term: selected_zipcode,
				city: $("#pickup_airport_city" ).val(),
				state: $("#pickup_airport_state" ).val()
            },
            success: function (data)
            {
				//alert(data);
				//alert(data.length);
				//console.log(data);
				//console.log(data[0].label);
				if(data)
				{
				var name = data[0].label;
				//alert(name);
				$( "#pickup_airport" ).val(data[0].label);
				$( "#pickup_airport_state" ).val(data[0].st_state);
				$( "#pickup_airport_city" ).val(data[0].st_city);
				}
				else
				{
					if(data == null || data === '')
					{
						alert('Please enter valid from location');
						$("#pickup_airport").val('');
					}
				}
				
            }
        });	
	}//!=''			
}
});	

$('#dropoff_airport').autocomplete({
		source: function (request, response)
   		 {
			request.term = $.trim(request.term);
			var str	= request.term;
			var letters = /^[a-zA-Z ]+$/;	
			if(str.match(letters))
			{
				request.term = str; 
			} else {
				str = str.toUpperCase();
				request.term = str.replace(/\s/g, ''); 
			}	 
			$.ajax(
			{
				url: base_url+"org_transportation/get_airports_by_zipcode_or_airport_id/" ,
				dataType: "json",
				data:
				{
					term: request.term
				},
				success: function (data)
				{
					//alert(data);	
					if(data=="1")
					{
						window.location.href=base_url;
					}
					/*if(data == null || data === '')
					{
						alert('Please enter valid to Zipcode/Airport ID');
						$("#dropoff_airport").val('');
					}
					else*/
					if(1)
					{
						response(data);
					}
				}
			});
  	  	}, 
		minLength:1,
		open: function() { $('.ui-menu').width($("#dropoff_airport" ).width()) },
		focus: function( event, ui ) {
				var id = ui.item.label;
				var name = ui.item.value;
				$("#dropoff_airport" ).val(name);
				$("#dropoff_airport_state" ).val(ui.item.st_state);
				$("#dropoff_airport_city" ).val(ui.item.st_city);
				return false;
		},     
		select: function( event, ui ) {
			var id = ui.item.label;
			var name = ui.item.value;
			$("#dropoff_airport" ).val(name);
			$("#dropoff_airport_state" ).val(ui.item.st_state);
			$("#dropoff_airport_city" ).val(ui.item.st_city);
			return false;
		}
	});	
$(document).on('change','#dropoff_airport',function(){
//var selected_zipcode = $(this).val();
var selected_zipcode = $.trim($(this).val());
var str	= selected_zipcode; 
//selected_zipcode = str.replace(/\s/g, ''); 

var letters = /^[a-zA-Z ]+$/;	
if(str.match(letters))
{
			 selected_zipcode = str; 
} else {
			 str = str.toUpperCase();  	
			 selected_zipcode = str.replace(/\s/g, ''); 
}
var select_pickup_city = $("#dropoff_airport_city" ).val();
var select_pickup_state = $("#dropoff_airport_state" ).val();
if ($("#dropoff_airport").val().indexOf(',') != -1 && $("#dropoff_airport").val().indexOf('USA') != -1 && $("#dropoff_airport").val().indexOf('Canada') != -1) {
	if(selected_zipcode != '' && select_pickup_city != '' && select_pickup_state != '' && select_pickup_country != '')
	{
		//$("#pickup_location").val(selected_zipcode+', '+select_pickup_city+', '+select_pickup_state+', '+select_pickup_country);
	}
}
else
{
	if(selected_zipcode!=''){
	  $.ajax({
            url: base_url+"org_transportation/get_airports_by_zipcode_or_airport_id/" ,
            dataType: "json",
            data:
            {
                term: selected_zipcode,
				city: $("#dropoff_airport_city" ).val(),
				state: $("#dropoff_airport_state" ).val()
            },
            success: function (data)
            {
				if(data)
				{
					var name = data[0].label;
					$( "#dropoff_airport" ).val(data[0].label);
					$( "#dropoff_airport_state" ).val(data[0].st_state);
					$( "#dropoff_airport_city" ).val(data[0].st_city);
				}
				else
				{
					if(data == null || data === '')
					{
						alert('Please enter valid to location');
						$("#dropoff_airport").val('');
					}
				}
				
            }
        });		
	}	 
}
});	

$(document).on('click','#airport_submit',function(){	
	
	if($('#addlegs').valid() == false) {
		return false;
	} else {
		
	
	   
	  var to_date = $('#dropoff_airport_clock').val();
	  var from_date = $('#pickup_airport_clock').val();
	 
	  var b;
	  var to_date_split = to_date.split('-');
	  var from_date_split = from_date.split('-');
	  if($('#pre-assign_volunteer-pilot').length > 0)
	  {
			var volunteer_name = $('#pre-assign_volunteer-pilot').val().replace(/\s/g,'');
	  } else {
		  var volunteer_name = '';
	  }	
	  if($('#pre-assign_volunteer-pilot-id').length > 0)
		{	
				var user_id = $('#pre-assign_volunteer-pilot-id').val();
		} else {
				var user_id = '0' ;
		}
			
		if($('#deleteuid-pilot').length > 0)
		{	
				var deleted_user_id = $('#deleteuid-pilot').val();
		} else {
				var deleted_user_id = '0' ;
		}
			
		if($('#non-doobertpilot-userid').length > 0)
		{	
				var non_doobert_userid = $('#non-doobertpilot-userid').val();
		} else {
				var non_doobert_userid = '0' ;
		}
	  
	  var frm_year = $('#pickup_airport_clock_year').val();
	  var to_year = $('#dropoff_airport_clock_year').val();
	  
	  var start_time_date = new Date(from_date_split[0]+frm_year);
	  var end_time_date = new Date(to_date_split[0]+to_year);
	  
	  var end_date = new Date(end_time_date.getFullYear(), end_time_date.getMonth(), end_time_date.getDate()); 
	  var start_date = new Date(start_time_date.getFullYear(), start_time_date.getMonth(), start_time_date.getDate()); 
	  
	  if (start_date > end_date) {
			alert("Start Date is greather than End Date.");
			return false;
	  } 
	  if (end_date < start_date) {
			alert("End Date is less than Start Date.");
			return false;
	  }
	  
		$('#transportleg_loader').modal('toggle');
		
		$("#aviation_display").modal('toggle');
		
	  
	  	if(edit_q!='')
		{	
			edit_sort_order = myArray[edit_q-1].in_sort_order;
			delete myArray[edit_q-1];	
		}
	  
		var pickup_address = ($("#pickup_airport").val()?"Zip Code/Airport Id: "+$("#pickup_airport").val():"");
		var	pickaddress = ($("#pickup_airport_city").val()?", "+$("#pickup_airport_city").val():"");
			pickaddress += ($("#pickup_airport_state").val()?", "+$("#pickup_airport_state").val():"");
			if(pickaddress!='')
			{
				pickup_address += pickaddress;
			}
		var dropoff_address = ($("#dropoff_airport").val()?"Zip Code/Airport Id: "+$("#dropoff_airport").val():"");
		var	dropoffaddress = ($("#dropoff_airport_city").val()?", "+$("#dropoff_airport_city").val():"");
			dropoffaddress += ($("#dropoff_airport_state").val()?", "+$("#dropoff_airport_state").val():"");
		if(dropoffaddress!='')
			{
				dropoff_address += dropoffaddress;
			}	
				
		var start_time 		 = $("#pickup_airport_clock").val();	
			start_time 		+= " - "+$("#pickup_airport_zone").val();	
		var end_time 		 = $("#dropoff_airport_clock").val();	
			end_time 		+= " - "+$("#dropoff_airport_zone").val();
	
		var leg_id 			= $("#leg_id").val();	
		var update_leg 		= "update";		
		
		var pilot_meeting_location = $("#meeting_location_from_pilot").val();
		
		var pick_dropoff    = pickup_address+'<i class="material-icons">keyboard_backspace</i>'+dropoff_address; 	
		var start_end_time = start_time+'<br>'+end_time;	
		
		var no_of_pilots = $("#no_of_pilots").val();
		legsArray = [];
		
		if(edit_q!='')
		{
			var i 		= edit_q-1;
			var c=[];
			var index 	= edit_q;	
			//var user_id = $('#pre-assign_volunteer-pilot-id').val();
			var sort_order = index;
			myArray[i]=({"pickup_street":addslashes($("#pickup_street").val()),"pickup_city":addslashes($("#pickup_city").val()),"pickup_state":addslashes($("#pickup_state").val()),"pickup_zip":addslashes($("#pickup_zip").val()),"pickup_country":addslashes($("#pickup_country").val()),"clockface_2_modal":$("#clockface_2_modal").val(),"pickup_zone":$("#pickup_zone").val(),"dropoff_street":addslashes($("#dropoff_street").val()),"dropoff_city":addslashes($("#dropoff_city").val()),"dropoff_state":addslashes($("#dropoff_state").val()),"dropoff_zip":addslashes($("#dropoff_zip").val()),"dropoff_country":addslashes($("#dropoff_country").val()),"clockface_3_modal":$("#clockface_3_modal").val(),"dropoff_zone":$("#dropoff_zone").val(),"leg_id":$("#leg_id").val(),"route_type":$("#route_type").val(),"route_type_id":$("#route_type_id").val(),"pickup_airport":addslashes($("#pickup_airport").val()),"pickup_airport_clock":$("#pickup_airport_clock").val(),"pickup_airport_zone":$("#pickup_airport_zone").val(),"dropoff_airport":addslashes($("#dropoff_airport").val()),"dropoff_airport_clock":$("#dropoff_airport_clock").val(),"dropoff_airport_zone":$("#dropoff_airport_zone").val(),"dropoff_airport_state":addslashes($("#dropoff_airport_state").val()),"dropoff_airport_city":addslashes($("#dropoff_airport_city").val()),"pickup_airport_state":addslashes($("#pickup_airport_state").val()),"pickup_airport_city":addslashes($("#pickup_airport_city").val()),"update_leg":"update","pilot_meeting_location":addslashes($("#meeting_location_from_pilot").val()),"no_of_pilots":addslashes($("#no_of_pilots").val()),"multiple_pilots":addslashes($("#multiple_pilots_txt").val()),"in_sort_order":edit_sort_order,'leg_instruction':addslashes($("#leg_instructions_aviation").val()),'to_meeting_location':addslashes($('#meeting_location_to_pilot').val()),'pick_year':addslashes($('#pickup_airport_clock_year').val()),'drop_year':addslashes($('#dropoff_airport_clock_year').val())});
			legsArray[0] = ({"pickup_street":addslashes($("#pickup_street").val()),"pickup_city":addslashes($("#pickup_city").val()),"pickup_state":addslashes($("#pickup_state").val()),"pickup_zip":addslashes($("#pickup_zip").val()),"pickup_country":addslashes($("#pickup_country").val()),"clockface_2_modal":$("#clockface_2_modal").val(),"pickup_zone":$("#pickup_zone").val(),"dropoff_street":addslashes($("#dropoff_street").val()),"dropoff_city":addslashes($("#dropoff_city").val()),"dropoff_state":addslashes($("#dropoff_state").val()),"dropoff_zip":addslashes($("#dropoff_zip").val()),"dropoff_country":addslashes($("#dropoff_country").val()),"clockface_3_modal":$("#clockface_3_modal").val(),"dropoff_zone":$("#dropoff_zone").val(),"leg_id":$("#leg_id").val(),"route_type":$("#route_type").val(),"route_type_id":$("#route_type_id").val(),"pickup_airport":addslashes($("#pickup_airport").val()),"pickup_airport_clock":$("#pickup_airport_clock").val(),"pickup_airport_zone":$("#pickup_airport_zone").val(),"dropoff_airport":addslashes($("#dropoff_airport").val()),"dropoff_airport_clock":$("#dropoff_airport_clock").val(),"dropoff_airport_zone":$("#dropoff_airport_zone").val(),"dropoff_airport_state":addslashes($("#dropoff_airport_state").val()),"dropoff_airport_city":addslashes($("#dropoff_airport_city").val()),"pickup_airport_state":addslashes($("#pickup_airport_state").val()),"pickup_airport_city":addslashes($("#pickup_airport_city").val()),"update_leg":"update","pilot_meeting_location":addslashes($("#meeting_location_from_pilot").val()),"no_of_pilots":addslashes($("#no_of_pilots").val()),"multiple_pilots":addslashes($("#multiple_pilots_txt").val()),"in_sort_order":edit_sort_order,'leg_instruction':addslashes($("#leg_instructions_aviation").val()),'to_meeting_location':addslashes($('#meeting_location_to_pilot').val()),'user_id':addslashes(user_id),'deleted_user_id':addslashes(deleted_user_id),'non_doobert_userid':addslashes(non_doobert_userid),'volunteer_name':addslashes(volunteer_name),'pick_year':addslashes($('#pickup_airport_clock_year').val()),'drop_year':addslashes($('#dropoff_airport_clock_year').val())});
			
			var sort_order_max = parseInt(edit_sort_order) + parseInt(1);
			var order_id = edit_sort_order; 	
			if(sort_order_max > 0)
			{	
				var counter= 0;	
				var count_loop=1;
				do {
					var inc_counter='0';	
					for(var k=0; k<myArray.length;++k)
					{
						inc_counter++;
						if(i != k)
						{	
							var value = myArray[k];
							if(myArray[k].update_leg !='delete')
							{
								if(sort_order_max == value.in_sort_order && value.route_type_id == '2' )
								{		
									sort_order_max = parseInt(sort_order_max) + parseInt(1);
									c[counter] = k;
									counter++;
									count_loop=1;
									break;
								} else if(sort_order_max == value.in_sort_order && value.route_type_id != '2' )
								{	
									c[counter] = k;
									counter++;
									count_loop=0;
									break;
								} else {
										next_counter_value = $.map(myArray, function( value, index ) {
														    if(index != i)
															{	
															   if(sort_order_max == value.in_sort_order && value.update_leg !='delete')
														    	return index;
															}	
														});
									 if(next_counter_value.length >0)
									 {
										 count_loop=1;
									 } else {
										 count_loop=0;
										 break;
									 }
								}
							}
						} else if(inc_counter == myArray.length ){
							count_loop=0;
						} 		
					}
				} while(count_loop!=0)		
				if(c.length >0)
				{		
					//b =	b[0];
				}	
				else 
				c = -1;
			} else {
				c = -1;				
			}
			
			/*if(c.length >0)
			{
				var k=0;
				for(var j=0;j<c.length;j++ )
				{
					b=c[j];
					if(myArray[b].route_type_id == '0')
					{
						var loc = $("#dropoff_airport").val();
						$.ajax({
							url: base_url+"org_transportation/get_loc_details/" ,
							type: "POST",
							//dataType: "json",
							async:false,
							data:{
							loc:loc 
							},
							success: function (data)
							{
								if(data!='fail')
								{	
									var loc_details = JSON.parse(data);
									myArray[b].pickup_city = loc_details.city;
									myArray[b].pickup_state =loc_details.state;
									myArray[b].pickup_zip = loc_details.postal_code;
									myArray[b].pickup_country = loc_details.country;	
								}
							},
						});
					} else if(myArray[b].route_type_id == '1')
					{
						myArray[b].pickup_street = addslashes($("#dropoff_airport").val());
						myArray[b].pickup_city = addslashes($("#dropoff_airport_city").val());
						myArray[b].pickup_airport_city = addslashes($("#dropoff_airport_city").val());
						myArray[b].pickup_state = addslashes($("#dropoff_airport_state").val());
						myArray[b].pickup_airport_state = addslashes($("#dropoff_airport_state").val());
						myArray[b].pickup_airport = addslashes($("#dropoff_airport").val());
						myArray[b].pickup_zip     = '';
						myArray[b].pickup_country = '';
					
					} else if(myArray[b].route_type_id == '2') {
						var loc = $("#dropoff_airport").val();
						$.ajax({
							url: base_url+"org_transportation/get_loc_details/" ,
							type: "POST",
							//dataType: "json",
							async:false,
							data:{
							loc:loc 
							},
							success: function (data)
							{
								if(data!='fail')
								{	
									var loc_details = JSON.parse(data);
									myArray[b].o_pickup_city = loc_details.city;
									myArray[b].o_pickup_state = loc_details.state;
									myArray[b].o_pickup_zip = loc_details.postal_code;
									myArray[b].o_pickup_country = loc_details.country;							
								}
							},
						});
					}
					k = parseInt(k) + parseInt(1);
					legsArray[k] = myArray[b];
				}		
			}*/		
		}
		else
		{
			q++;
			c=-1;
			var index = q;
			var i = index;
			var sort_order = index;
				if(myArray.length == 0 )
				{
					sort_order = 1;				
				}else{
					var get_sort_order = $.map( myArray, function( value, index ) {
											return value.in_sort_order;
								});
								if(get_sort_order.length > 0)
								{	
									var max_order_value	 = 	Math.max.apply(Math,get_sort_order);
									
								} else {
											var max_order_value = 0;
								}
							sort_order   = parseInt(max_order_value) + parseInt(1);
				}
			var order_id = sort_order;
			//var user_id = $('#pre-assign_volunteer-pilot-id').val();			
			myArray.push({"pickup_street":addslashes($("#pickup_street").val()),"pickup_city":addslashes($("#pickup_city").val()),"pickup_state":addslashes($("#pickup_state").val()),"pickup_zip":addslashes($("#pickup_zip").val()),"pickup_country":addslashes($("#pickup_country").val()),"clockface_2_modal":$("#clockface_2_modal").val(),"pickup_zone":$("#pickup_zone").val(),"dropoff_street":addslashes($("#dropoff_street").val()),"dropoff_city":addslashes($("#dropoff_city").val()),"dropoff_state":addslashes($("#dropoff_state").val()),"dropoff_zip":addslashes($("#dropoff_zip").val()),"dropoff_country":addslashes($("#dropoff_country").val()),"clockface_3_modal":$("#clockface_3_modal").val(),"dropoff_zone":$("#dropoff_zone").val(),"leg_id":$("#leg_id").val(),"route_type":$("#route_type").val(),"route_type_id":$("#route_type_id").val(),"pickup_airport":addslashes($("#pickup_airport").val()),"pickup_airport_clock":$("#pickup_airport_clock").val(),"pickup_airport_zone":$("#pickup_airport_zone").val(),"dropoff_airport":addslashes($("#dropoff_airport").val()),"dropoff_airport_clock":$("#dropoff_airport_clock").val(),"dropoff_airport_zone":$("#dropoff_airport_zone").val(),"dropoff_airport_state":addslashes($("#dropoff_airport_state").val()),"dropoff_airport_city":addslashes($("#dropoff_airport_city").val()),"pickup_airport_state":addslashes($("#pickup_airport_state").val()),"pickup_airport_city":addslashes($("#pickup_airport_city").val()),"update_leg":"update","pilot_meeting_location":addslashes($("#meeting_location_from_pilot").val()),"no_of_pilots":addslashes($("#no_of_pilots").val()),"multiple_pilots":addslashes($("#multiple_pilots_txt").val()),"in_sort_order":sort_order,'leg_instruction':addslashes($("#leg_instructions_aviation").val()),'to_meeting_location':addslashes($('#meeting_location_to_pilot').val()),'pick_year':addslashes($('#pickup_airport_clock_year').val()),'drop_year':addslashes($('#dropoff_airport_clock_year').val())});
			legsArray[0] = ({"pickup_street":addslashes($("#pickup_street").val()),"pickup_city":addslashes($("#pickup_city").val()),"pickup_state":addslashes($("#pickup_state").val()),"pickup_zip":addslashes($("#pickup_zip").val()),"pickup_country":addslashes($("#pickup_country").val()),"clockface_2_modal":$("#clockface_2_modal").val(),"pickup_zone":$("#pickup_zone").val(),"dropoff_street":addslashes($("#dropoff_street").val()),"dropoff_city":addslashes($("#dropoff_city").val()),"dropoff_state":addslashes($("#dropoff_state").val()),"dropoff_zip":addslashes($("#dropoff_zip").val()),"dropoff_country":addslashes($("#dropoff_country").val()),"clockface_3_modal":$("#clockface_3_modal").val(),"dropoff_zone":$("#dropoff_zone").val(),"leg_id":$("#leg_id").val(),"route_type":$("#route_type").val(),"route_type_id":$("#route_type_id").val(),"pickup_airport":addslashes($("#pickup_airport").val()),"pickup_airport_clock":$("#pickup_airport_clock").val(),"pickup_airport_zone":$("#pickup_airport_zone").val(),"dropoff_airport":addslashes($("#dropoff_airport").val()),"dropoff_airport_clock":$("#dropoff_airport_clock").val(),"dropoff_airport_zone":$("#dropoff_airport_zone").val(),"dropoff_airport_state":addslashes($("#dropoff_airport_state").val()),"dropoff_airport_city":addslashes($("#dropoff_airport_city").val()),"pickup_airport_state":addslashes($("#pickup_airport_state").val()),"pickup_airport_city":addslashes($("#pickup_airport_city").val()),"update_leg":"update","pilot_meeting_location":addslashes($("#meeting_location_from_pilot").val()),"no_of_pilots":addslashes($("#no_of_pilots").val()),"multiple_pilots":addslashes($("#multiple_pilots_txt").val()),"in_sort_order":sort_order,'leg_instruction':addslashes($("#leg_instructions_aviation").val()),'to_meeting_location':addslashes($('#meeting_location_to_pilot').val()),'user_id':addslashes(user_id),'deleted_user_id':addslashes(deleted_user_id),'non_doobert_userid':addslashes(non_doobert_userid),'volunteer_name':addslashes(volunteer_name),'pick_year':addslashes($('#pickup_airport_clock_year').val()),'drop_year':addslashes($('#dropoff_airport_clock_year').val())});
		}
			
			legsArray = JSON.stringify(legsArray);
			
			 $.ajax({ 
					type:'POST',
					url:base_url+"org_transportation/create_legs/"+transport_id+"/",
					async:false,
					data:{
						legsArray:legsArray,
					}, 
					success:function( data ) 
					{
						if(user_id == 'n-d-u')
							{
								$('#non_doobert_user_transport_leg_id').val(data);
							}
					},	
				});	
		
			if(user_id == 'n-d-u')
			{
				$('#assign-nondoobert-user').modal('show');
			} else {
			var cname = 'edit_legs';
			var cvalue = '1';
			var exdays = '1';
			var d = new Date();
			d.setTime(d.getTime() + (exdays*24*60*60*1000));
			var expires = "expires="+ d.toUTCString();
			document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;domain=.doobert.com";
			window.location = base_url+'transport-create-legs/';
			}	
	}
});	

$('#o_pickup_location').autocomplete({
	 
	source: function (request, response)
    {
		request.term = $.trim(request.term);
		var str	= request.term;
		var letters = /^[a-zA-Z ]+$/;	
		if(str.match(letters))
		{
			request.term = str; 
		} else {
			str = str.toUpperCase();
			request.term = str.replace(/\s/g, ''); 
		}	
        $.ajax(
        {
            url: base_url+"org_transportation/get_zip_code2/" ,
            dataType: "json",
            data:
            {
                term: request.term,
				city: $("#o_pick_city" ).val(),
				state: $("#o_pick_state" ).val()
            },
            success: function (data)
            {
				//console.log(data);
				if(data=="1")
				{
					window.location.href=base_url;
				}
				else
				{
                	response(data);
				}
            }
        });
    },
	minLength:1,
	open: function() { $('.ui-menu').width($("#o_pickup_location" ).width())},
	focus: function( event, ui ) {
			var id = ui.item.label;
			var name = ui.item.value;
			$("#o_pickup_location" ).val(name);
			$("#o_pickup_country" ).val(ui.item.st_country);
			//country_state(ui.item.st_country,"pick");
			$("#o_pickup_city" ).val(ui.item.city);
			$("#o_pickup_state" ).val(ui.item.state_prefix);
			$("#o_pickup_zip").val(name);
			//alert('value replace');
			return false;
	},     
	select: function( event, ui ) {
		var id = ui.item.label;
		var name = ui.item.value;
		//$("#pick_zip" ).val(name);
		$("#o_pickup_location" ).val(id);
		$("#o_pickup_country" ).val(ui.item.st_country);
		//country_state(ui.item.st_country,"pick");
		$("#o_pickup_city" ).val(ui.item.city);
		$("#o_pickup_state" ).val(ui.item.state_prefix);
		$("#o_pickup_zip").val(name);
		
		return false;
	}
	});
	
$(document).on('change','#o_pickup_location',function(){
//var selected_zipcode = $(this).val();
var selected_zipcode = $.trim($(this).val());
var str	= selected_zipcode; 

var letters = /^[a-zA-Z ]+$/;	
if(str.match(letters))
{
			 selected_zipcode = str; 
} else {
			 str = str.toUpperCase();  	
			 selected_zipcode = str.replace(/\s/g, ''); 
}


var select_pickup_city = $("#o_pickup_city" ).val();

var select_pickup_state = $("#o_pickup_state" ).val();

var select_pickup_country = $("#o_pickup_country" ).val();


if ($("#o_pickup_location").val().indexOf(',') != -1 && $("#o_pickup_location").val().indexOf('USA') != -1 && $("#o_pickup_location").val().indexOf('Canada') != -1) {
	if(selected_zipcode != '' && select_pickup_city != '' && select_pickup_state != '' && select_pickup_country != '')
	{
		$("#o_pickup_location").val(selected_zipcode+', '+select_pickup_city+', '+select_pickup_state+', '+select_pickup_country);
	}
}
else
{
	if(selected_zipcode!=''){
	  $.ajax({
            url: base_url+"org_transportation/get_zip_code2/" ,
            dataType: "json",
            data:
            {
                term: selected_zipcode,
				city: $("#o_pickup_city" ).val(),
				state: $("#o_pickup_state" ).val()
            },
            success: function (data)
            {
				if(data)
				{
				$("#o_pickup_location").val(data[0].label);
				$("#o_pickup_country" ).val(data[0].st_country);
				$("#o_pickup_city" ).val(data[0].city);
				$("#o_pickup_state" ).val(data[0].state_prefix);
				$("#o_pickup_zip").val(data[0].value);
				}
				else
				{
					if($("#o_pickup_location").val().indexOf(',') == -1)
					{
						alert('Please enter valid overnight location');
						$("#o_pickup_location").val('');
					}
				}
				
            }
        });		
	}
}
});

$(document).on('click','#overnight_submit',function(){	

		
		
	  
	  if($('#addlegs').valid() == false) {
		return false;
	} else {

		if(edit_q!='')
		{	
			edit_sort_order = myArray[edit_q-1].in_sort_order;
			delete myArray[edit_q-1];	
		}
		
		var o_pickup_address  = ($("#o_pickup_street").val()?$("#o_pickup_street").val()+", ":"");
			o_pickup_address += ($("#o_pickup_city").val()?$("#o_pickup_city").val()+", ":"");
			o_pickup_address += ($("#o_pickup_state").val()?$("#o_pickup_state").val():"");
			o_pickup_address += ($("#o_pickup_zip").val()?", "+$("#o_pickup_zip").val():"");
		
		if($('#pre-assign_volunteer-overnight').length > 0)
		{	
			var volunteer_name = $('#pre-assign_volunteer-overnight').val().replace(/\s/g,'');
		} else {
			var volunteer_name = '';
		}
		 if($('#pre-assign_volunteer-overnight-id').length > 0)
		{	
				var user_id = $('#pre-assign_volunteer-overnight-id').val();
		} else {
				var user_id = '0' ;
		}
			
		if($('#deleteuid-overnight').length > 0)
		{	
				var deleted_user_id = $('#deleteuid-overnight').val();
		} else {
				var deleted_user_id = '0' ;
		}
			
		if($('#non-doobertovernight-userid').length > 0)
		{	
				var non_doobert_userid = $('#non-doobertovernight-userid').val();
		} else {
				var non_doobert_userid = '0' ;
		}
	  
		
		var leg_id 			= $("#leg_id").val();	
		var update_leg 		= "update";		
		var b;
		legsArray = [];
		var overnight_comments = $("#overnight_comments").val();
		
		$("#overnight_display").modal('toggle');
		$('#transportleg_loader').modal('toggle');
		
		if(edit_q!='')
		{
			var i 		= edit_q-1;
			
			var index 	= edit_q;	
			
			var sort_order = index;
			//var user_id = $('#pre-assign_volunteer-overnight-id').val();
			
			if(myArray[i-1])
			{
				if(typeof myArray[i-1].in_sort_order === 'undefined')
				{
					sort_order = 1;				
				}else{
					sort_order = parseInt(myArray[i-1].in_sort_order) + parseInt(1);
					}
			}
			
			var sort_order_max = parseInt(edit_sort_order) + parseInt(1);
			var order_id = edit_sort_order;
			if(sort_order_max > 0)
			{	
				 b = $.map(myArray, function( value, index ) {
											if(index != i)
											{	
												if(sort_order_max == value.in_sort_order && value.update_leg !='delete' )
													return index;
											}	
								});
				if(b.length >0)				
					b =	b[0];
				else 
					b = -1;
			} else {
				b = -1;
			}
			
			/*if(b!=-1)
			{
				if(myArray[b].route_type_id == '0')
				{
					myArray[b].pickup_street = addslashes($("#o_pickup_street").val());
					myArray[b].pickup_city = addslashes($("#o_pickup_city").val());
					myArray[b].pickup_state = addslashes($("#o_pickup_state").val());
					myArray[b].pickup_zip = addslashes($("#o_pickup_zip").val());
					myArray[b].pickup_country = addslashes($("#o_pickup_country").val());
				} else if(myArray[b].route_type_id == '1')
				{
						var term = $("#o_pickup_zip").val();
						$.ajax({
						url: base_url+"org_transportation/get_airports_by_zipcode_or_airport_id/" ,
						dataType: "json",
						async:false,
						data:{
						term:term 
						},
						success: function (data)
						{
							myArray[b].pickup_street = data[0].value;
							myArray[b].pickup_airport = data[0].value;
							myArray[b].pickup_airport_state = data[0].st_state;
							myArray[b].pickup_airport_city = data[0].st_city;
							myArray[b].pickup_city    = data[0].st_city;
							myArray[b].pickup_state   = data[0].st_state;	
						},
					});
						myArray[b].pickup_zip         = '';
						myArray[b].pickup_country     = '';	
				} 		
			}*/		
			myArray[i]=({"o_pickup_street":addslashes($("#o_pickup_street").val()),"o_pickup_city":addslashes($("#o_pickup_city").val()),"o_pickup_state":addslashes($("#o_pickup_state").val()),"o_pickup_zip":addslashes($("#o_pickup_zip").val()),"o_pickup_country":addslashes($("#o_pickup_country").val()),"update_leg":"update","overnight_comments":addslashes($("#overnight_comments").val()),"leg_id":$("#leg_id").val(),"route_type":$("#route_type").val(),"route_type_id":$("#route_type_id").val(),"in_sort_order":edit_sort_order});
			legsArray[0] = ({"o_pickup_street":addslashes($("#o_pickup_street").val()),"o_pickup_city":addslashes($("#o_pickup_city").val()),"o_pickup_state":addslashes($("#o_pickup_state").val()),"o_pickup_zip":addslashes($("#o_pickup_zip").val()),"o_pickup_country":addslashes($("#o_pickup_country").val()),"update_leg":"update","overnight_comments":addslashes($("#overnight_comments").val()),"leg_id":$("#leg_id").val(),"route_type":$("#route_type").val(),"route_type_id":$("#route_type_id").val(),"in_sort_order":edit_sort_order,'user_id':addslashes(user_id),'deleted_user_id':addslashes(deleted_user_id),'non_doobert_userid':addslashes(non_doobert_userid),'volunteer_name':addslashes(volunteer_name)});
			/*if(b!=-1)
			{
				legsArray[1] = myArray[b];
			}*/	
		}
		else
		{
			q++;
			
			var index = q;	
			b=-1;
			var i = index;
			var sort_order = index;
				if(myArray.length == 0 )	
				{
					sort_order = 1;				
				}else{
					var get_sort_order = $.map( myArray, function( value, index ) {
											return value.in_sort_order;
								});
								if(get_sort_order.length > 0)
								{	
									var max_order_value	 = 	Math.max.apply(Math,get_sort_order);
									
								} else {
											var max_order_value = 0;
								}	
							
							        sort_order   = parseInt(max_order_value) + parseInt(1);
			}
			var order_id = sort_order;	
			//var user_id = $('#pre-assign_volunteer-overnight-id').val();	
			myArray.push({"o_pickup_street":addslashes($("#o_pickup_street").val()),"o_pickup_city":addslashes($("#o_pickup_city").val()),"o_pickup_state":addslashes($("#o_pickup_state").val()),"o_pickup_zip":addslashes($("#o_pickup_zip").val()),"o_pickup_country":addslashes($("#o_pickup_country").val()),"update_leg":"update","overnight_comments":addslashes($("#overnight_comments").val()),"leg_id":$("#leg_id").val(),"route_type":$("#route_type").val(),"route_type_id":$("#route_type_id").val(),"in_sort_order":sort_order});
			legsArray[0] = ({"o_pickup_street":addslashes($("#o_pickup_street").val()),"o_pickup_city":addslashes($("#o_pickup_city").val()),"o_pickup_state":addslashes($("#o_pickup_state").val()),"o_pickup_zip":addslashes($("#o_pickup_zip").val()),"o_pickup_country":addslashes($("#o_pickup_country").val()),"update_leg":"update","overnight_comments":addslashes($("#overnight_comments").val()),"leg_id":$("#leg_id").val(),"route_type":$("#route_type").val(),"route_type_id":$("#route_type_id").val(),"in_sort_order":sort_order,'user_id':addslashes(user_id),'deleted_user_id':addslashes(deleted_user_id),'non_doobert_userid':addslashes(non_doobert_userid),'volunteer_name':addslashes(volunteer_name)});
		}
		
			legsArray = JSON.stringify(legsArray);
			
			 $.ajax({ 
					type:'POST',
					url:base_url+"org_transportation/create_legs/"+transport_id+"/",
					async:false,
					data:{
						legsArray:legsArray,
					}, 
					success:function( data ) 
					{
						if(user_id == 'n-d-u')
							{
								$('#non_doobert_user_transport_leg_id').val(data);
							}	
					},	
				});	
		
			if(user_id == 'n-d-u')
			{
				$('#assign-nondoobert-user').modal('show');
			} else {
			var cname = 'edit_legs';
			var cvalue = '1';
			var exdays = '1';
			var d = new Date();
			d.setTime(d.getTime() + (exdays*24*60*60*1000));
			var expires = "expires="+ d.toUTCString();
			document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;domain=.doobert.com";
			window.location = base_url+'transport-create-legs/';
			}
	}
});	

function addslashes(str) {
	if(str)
	{
		str=str.replace(/\\/g,'\\\\');
		str=str.replace(/\'/g,'\\\'');
		str=str.replace(/\"/g,'\\"');
		str=str.replace(/\0/g,'\\0');
		return str;
	}
	else{
		return "";
	}
}
function stripslashes(str) {
	if(str)
	{
		str=str.replace(/\\'/g,'\'');
		str=str.replace(/\\"/g,'"');
		str=str.replace(/\\0/g,'\0');
		str=str.replace(/\\\\/g,'\\');
		return str;
	}
	else{
		return "";
	}
}

function edit_leges(q,e)
{
	if(add_flg!='' && edit_q=='')
	{
		$("#address_display").hide();
		$("#aviation_display").hide();	
		$("#overnight_display").hide();	
	}
	flag='';
	if(flag=='')
	{
		if($("#tr_"+q).prev().attr('id'))
		{
			flag 	= $("#tr_"+q).prev().attr('id');
		}
		else
		{	
			var tr_no = q-1;		
			flag 	= "tr_"+tr_no;	
		}
		//console.log()
		edit_q	= q;	//$('#tr_'+ q).fadeOut('slow'); 
		var trId = e.closest('tr').prop('id');
		editedTrid = e.closest('tr').prop('id');
		tr_cnt = trId.substr(trId.indexOf("_") + 1);
		/*if($( window ).width() <= 767)
		{
			e.closest('table').remove();
		} else {
		$('#'+trId).remove();
		}*/
		var a = q-1;
		//console.log(myArray);
	
		if(myArray[a].route_type_id=='1')
		{
				
		
			if(myArray[a].multiple_drivers_pilots == 1)
			{
				$('#multiple_pilots').prop('checked', true);
				$('#multiple_pilots_txt').val('1');
			}
			if(myArray[a].no_of_pilots >= 2)
			{
				$("#no_of_pilots_div").show();
				$("#pilot_meeting_location_div").show();
				$("#no_of_pilots").val(stripslashes(myArray[a].no_of_pilots));
			}
			
			if(myArray[a].in_user_id!='' && myArray[a].st_user_name!='')
			{	
				$('#pre-assign_volunteer-pilot').val(stripslashes(myArray[a].st_user_name));
				$('#pre-assign_volunteer-pilot-id').val(stripslashes(myArray[a].in_user_id));
				$('#deleteuid-pilot').val(stripslashes(myArray[a].in_user_id));
			} else {
				if(myArray[a].non_doobert_userid!='' && myArray[a].nondoobert_user_name!='')
				{
					$('#pre-assign_volunteer-pilot').val(stripslashes(myArray[a].nondoobert_user_name));
					$('#non-doobertpilot-userid').val(stripslashes(myArray[a].non_doobert_userid));
				}	
			}
			
			$('#leg_instructions_aviation').val(myArray[a].leg_instruction);
			$('#pickup_airport_clock_year').val(myArray[a].pick_year);
			$('#dropoff_airport_clock_year').val(myArray[a].drop_year);
			//$("#meeting_location_from_pilot").val(stripslashes(myArray[a].pilot_meeting_location));
			
			if(myArray[a].pilot_meeting_location!='')
			{	
				$("#meeting_location_from_pilot").val(stripslashes(myArray[a].pilot_meeting_location));
			} else {
				if(myArray[a].in_sort_order!='1' && myArray[a].in_sort_order!='')
				{
					$.ajax({
					type: "POST",
				    url: base_url+'org_transportation/get_last_meeting_location',
				   async:false,
				    data: {
					  leg_id : myArray[a].in_sort_order-1,					   
					},
				   success:function(data) 
				   {
						if(data!='')
						{
							$('#meeting_location_from_pilot').val(data);
						}
				   }
					});
				}	
			}
			
			$("#meeting_location_to_pilot").val(stripslashes(myArray[a].to_meeting_location));
			
			$("#aviation_display").modal('show');
		}
		else if(myArray[a].route_type_id=='0')
		{
			//console.log('edit leg date:'+myArray[a].clockface_2_modal);
			
			$('#leg_instructions').val(myArray[a].leg_instruction);
			//$("#meeting_location_from_driver").val(stripslashes(myArray[a].meeting_location));
			
			if(myArray[a].meeting_location!='')
			{	
				$("#meeting_location_from_driver").val(stripslashes(myArray[a].meeting_location));
			} else {
				if(myArray[a].in_sort_order!='1' && myArray[a].in_sort_order!='')
				{
					$.ajax({
					type: "POST",
				    url: base_url+'org_transportation/get_last_meeting_location',
				   async:false,
				    data: {
					  leg_id : myArray[a].in_sort_order-1,					   
					},
				   success:function(data) 
				   {
						if(data!='')
						{
							$('#meeting_location_from_driver').val(data);
						}
				   }
					});
				}	
			}	
			
			$("#meeting_location_to_driver").val(stripslashes(myArray[a].to_meeting_location));
			if(myArray[a].in_user_id!='' && myArray[a].st_user_name!='')
			{	
				$('#pre-assign_volunteer-driver').val(stripslashes(myArray[a].st_user_name));
				$('#pre-assign_volunteer-driver-id').val(stripslashes(myArray[a].in_user_id));
				$('#deleteuid-driver1').val(stripslashes(myArray[a].in_user_id));
			} else {
				if(myArray[a].non_doobert_userid!='' && myArray[a].nondoobert_user_name!='')
				{
					$('#pre-assign_volunteer-driver').val(stripslashes(myArray[a].nondoobert_user_name));
					$('#non-doobert-userid').val(stripslashes(myArray[a].non_doobert_userid));
				}	
			}
			$('#clockface_2_modal_year').val(myArray[a].pick_year);
			$('#clockface_3_modal_year').val(myArray[a].drop_year);	
			$("#address_display").modal('show');	
		}
		
		else if(myArray[a].route_type_id=='2')
		{
			
			$("#overnight_display").modal('show');	
			$("#o_pickup_street").val(stripslashes(myArray[a].o_pickup_street));
			$("#o_pickup_city").val(stripslashes(myArray[a].o_pickup_city));
			$("#o_pickup_state").val(stripslashes(myArray[a].o_pickup_state));
			$("#o_pickup_country").val(stripslashes(myArray[a].o_pickup_country));
			$("#o_pickup_zip").val(stripslashes(myArray[a].o_pickup_zip));
			//$("#overnight_comments").val(stripslashes(myArray[a].overnight_comments));
			
			if(myArray[a].overnight_comments!='')
			{	
				$("#overnight_comments").val(stripslashes(myArray[a].overnight_comments));
			} else {
				if(myArray[a].in_sort_order!='1' && myArray[a].in_sort_order!='')
				{
					$.ajax({
					type: "POST",
				    url: base_url+'org_transportation/get_last_meeting_location',
				   async:false,
				    data: {
					  leg_id : myArray[a].in_sort_order-1,					   
					},
				   success:function(data) 
				   {
						if(data!='')
						{
							$('#overnight_comments').val(data);
						}
				   }
					});
				}	
			}
			
			var c = $("#o_pickup_city").val();
			var co = $("#o_pickup_country").val();
			var s = $("#o_pickup_state").val();	
			var z =$("#o_pickup_zip").val();
			var pickval = z+', '+c+', '+s+', '+co;
			$('#o_pickup_location').val(pickval);
			if(myArray[a].in_user_id!='' && myArray[a].st_user_name!='')
			{	
				$('#pre-assign_volunteer-overnight').val(stripslashes(myArray[a].st_user_name));
				$('#pre-assign_volunteer-overnight-id').val(stripslashes(myArray[a].in_user_id));
				$('#deleteuid-overnight').val(stripslashes(myArray[a].in_user_id));
			} else {
				if(myArray[a].non_doobert_userid!='' && myArray[a].nondoobert_user_name!='')
				{
					$('#pre-assign_volunteer-overnight').val(stripslashes(myArray[a].nondoobert_user_name));
					$('#non-doobertovernight-userid').val(stripslashes(myArray[a].non_doobert_userid));
				}	
			}
		}
		
		var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
		var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun","Jul", "Aug", "Sept", "Oct", "Nov", "Dec"];
		
		$("#pickup_street").val(stripslashes(myArray[a].pickup_street));
		$("#pickup_city").val(stripslashes(myArray[a].pickup_city));
		$("#pickup_state").val(stripslashes(myArray[a].pickup_state));
		$("#pickup_zip").val(stripslashes(myArray[a].pickup_zip));
		$("#pickup_country").val(stripslashes(myArray[a].pickup_country));
		$("#dropoff_street").val(stripslashes(myArray[a].dropoff_street));
		$("#dropoff_country").val(stripslashes(myArray[a].dropoff_country));
		$("#dropoff_city").val(stripslashes(myArray[a].dropoff_city));
		$("#dropoff_state").val(stripslashes(myArray[a].dropoff_state));
		$("#dropoff_zip").val(stripslashes(myArray[a].dropoff_zip));
		$("#clockface_2_modal").val(myArray[a].clockface_2_modal);	
		
		var from_date = $('#clockface_2_modal').val();
		
		//console.log('ground-leg old from_date'+from_date);
		//myArray[a].pick_year myArray[a].drop_year
		
		var from_date_split = from_date.split('-');
		var ground_start_date = new Date(from_date_split[0]+myArray[a].pick_year);		
		var gfromdayName = days[ground_start_date.getDay()];
		//console.log('gfromdayName'+gfromdayName);
		var gfrommonthName =  monthNames[ground_start_date.getMonth()];
		//console.log('gfrommonthName'+gfrommonthName);
		var gfrom_date = ("0" + ground_start_date.getDate()).slice(-2);
		//console.log('gfrom_date'+gfrom_date);		
		if(typeof gfromdayName != 'undefined' && typeof gfrommonthName != 'undefined' && typeof gfrom_date != 'undefined')
		{			
			$('#clockface_2_modal').val(gfromdayName+' '+gfrommonthName+' '+gfrom_date+' - '+from_date_split[1]);
			//console.log('clockface_2_modal value:'+$('#clockface_2_modal').val());
		}
		
		$("#clockface_3_modal").val(myArray[a].clockface_3_modal);
		
		var to_date = $('#clockface_3_modal').val();
		var to_date_split = to_date.split('-');
		var ground_end_date = new Date(to_date_split[0]+myArray[a].drop_year);		
		var genddayName = days[ground_end_date.getDay()];
		//console.log('genddayName'+genddayName);
		var gendmonthName =  monthNames[ground_end_date.getMonth()];
		//console.log('gendmonthName'+gendmonthName);
		var gend_date = ("0" + ground_end_date.getDate()).slice(-2);
		//console.log('gend_date'+gend_date);
		if(typeof genddayName != 'undefined' && typeof gendmonthName != 'undefined' && typeof gend_date != 'undefined')
		{
			$('#clockface_3_modal').val(genddayName+' '+gendmonthName+' '+gend_date+' - '+to_date_split[1]);
		}
		
		$("#leg_id").val(myArray[a].leg_id);	
		$("#route_type").val(myArray[a].route_type);
		$("#route_type_id").val(myArray[a].route_type_id);
		
		$("#dropoff_airport").val(stripslashes(myArray[a].dropoff_airport));
		$("#dropoff_airport_clock").val(myArray[a].dropoff_airport_clock);
		
		var to_date_air = $('#dropoff_airport_clock').val();
		var to_date_air_split = to_date_air.split('-');
		var air_end_date = new Date(to_date_air_split[0]+myArray[a].drop_year);		
		var aenddayName = days[air_end_date.getDay()];
		//console.log('aenddayName'+aenddayName);
		var aendmonthName =  monthNames[air_end_date.getMonth()];
		//console.log('aendmonthName'+aendmonthName);
		var aend_date = ("0" + air_end_date.getDate()).slice(-2);
		//console.log('aend_date'+aend_date);		
		if(typeof aenddayName != 'undefined' && typeof aendmonthName != 'undefined' && typeof aend_date != 'undefined')
		{
			$('#dropoff_airport_clock').val(aenddayName+' '+aendmonthName+' '+aend_date+' - '+to_date_air_split[1]);
		}
		
		$("#dropoff_airport_zone").val(myArray[a].dropoff_airport_zone);
		$("#dropoff_airport_city").val(stripslashes(myArray[a].dropoff_airport_city));
		$("#dropoff_airport_state").val(stripslashes(myArray[a].dropoff_airport_state));
	
		$("#pickup_airport").val(stripslashes(myArray[a].pickup_airport));
		$("#pickup_airport_clock").val(myArray[a].pickup_airport_clock);
		
		var from_date_air = $('#pickup_airport_clock').val();
		var from_date_air_split = from_date_air.split('-');
		var air_start_date = new Date(from_date_air_split[0]+myArray[a].pick_year);		
		var afromdayName = days[air_start_date.getDay()];
		//console.log('afromdayName'+afromdayName);
		var afrommonthName =  monthNames[air_start_date.getMonth()];
		//console.log('afrommonthName'+afrommonthName);
		var afrom_date = ("0" + air_start_date.getDate()).slice(-2);
		//console.log('afrom_date'+afrom_date);		
		if(typeof afromdayName != 'undefined' && typeof afrommonthName != 'undefined' && typeof afrom_date != 'undefined')
		{
			$('#pickup_airport_clock').val(afromdayName+' '+afrommonthName+' '+afrom_date+' - '+from_date_air_split[1]);
		}
		
		$("#pickup_airport_zone").val(myArray[a].pickup_airport_zone);
		$("#pickup_airport_city").val(stripslashes(myArray[a].pickup_airport_city));
		$("#pickup_airport_state").val(stripslashes(myArray[a].pickup_airport_state));
		
		document.getElementById("dropoff_zone").value = myArray[a].dropoff_zone;
		document.getElementById("pickup_zone").value = myArray[a].pickup_zone;
		
		$("#no_of_drivers").val(stripslashes(myArray[a].no_of_drivers));
		
		$("#multiple_drivers_pilots").val(stripslashes(myArray[a].multiple_drivers_pilots));
	
		var c = $("#pickup_city").val();
		var co = $("#pickup_country").val();
			var s = $("#pickup_state").val();	
			var z =$("#pickup_zip").val();
			var pickval = z+', '+c+', '+s+', '+co;
			$('#pickup_location').val(pickval);
			
	var c = $("#dropoff_city").val();
			var co = $("#dropoff_country").val();
			var s = $("#dropoff_state").val();	
			var z =$("#dropoff_zip").val();
			var pickval = z+', '+c+', '+s+', '+co;
			$('#dropoff_location').val(pickval);

	if(myArray[a].route_type_id==0)
	{
		from_date_setup = $('#clockface_2_modal').val();
		to_date_setup 	= $('#clockface_3_modal').val();
	} else if(myArray[a].route_type_id==1)
	{
		from_date_setup = $('#pickup_airport_clock').val(); 
		to_date_setup 	= $('#dropoff_airport_clock').val(); 
	}		
			
	if(myArray[a].multiple_drivers_pilots == 1)
	{
		$('#multiple_drivers').prop('checked', true);
		$('#multiple_drivers_txt').val('1');
	}
	if(myArray[a].no_of_drivers >= 2)
	{
		$("#no_of_drivers_div").show();
		$("#meeting_location_div").show();
		$("#no_of_drivers").val(stripslashes(myArray[a].no_of_drivers));
		$("#meeting_location").val(stripslashes(myArray[a].meeting_location));
	}
	
	}
	else
	{
		//alert("Update your current leg.");
		alert("Please scroll down to complete editing the currently selected leg.");
	}
}

function delete_leges(q,e)
{
	if(confirm("Are you sure, Do you want to delete this leg?"))
	{
		$('#leg_deleted').val(1);
		//$('#tr_'+ q).remove();
		
		if($( window ).width() <= 767)
		{
			e.closest('table').remove();	
		} else {
			var trId = e.closest('tr').prop('id');
			tr_cnt = trId.substr(trId.indexOf("_") + 1);
			$('#'+trId).remove();	
		}
		
		/*var trId = e.closest('tr').prop('id');
		tr_cnt = trId.substr(trId.indexOf("_") + 1);
		$('#'+trId).remove();*/
		
		var a = q-1;
		
		var leg_id = myArray[a].leg_id;
		
		var in_distance_covered = jQuery("#distance_covered").val() ;
		var distance_total = jQuery("#distance_total").val() ;
		var distance_remaining = jQuery("#distance_remaining").val() ;
		
		//var distance_remain_total = jQuery("#distance_remain").html() ;
		//var distance_remain_total_array = distance_remain_total.split(" ");
		
		var delete_leg	 = new Array();
		delete_leg = myArray[a];
		
		var route_type = myArray[a].route_type_id;
		
		var prev_sort_order = myArray[a].in_sort_order;
		var new_sort_order = myArray[a].in_sort_order;
		
		delete myArray[a];		
			
		myArray[a]=({"leg_id":leg_id,"update_leg":"delete"});
		
		legsArray = [];
		legsArray[0] = ({"leg_id":leg_id,"update_leg":"delete"});
		//console.log(myArray);
		 
		if($( window ).width() <= 767)
		{	
					for(var i=q;i<myArray.length;i++)
					{
						if(myArray[i]['leg_id']!='' && myArray[i]['update_leg'] != 'delete')
						{	
							myArray[i]['in_sort_order'] = new_sort_order;
							new_sort_order++;
						}	
					}	
		 } else {	 
			renumber_table('#leg_table_body');
		 }
		 //renumber_table('#leg_table_body');
		 	var jsondata = JSON.stringify(myArray);
			
			$('#legs_reorder').modal('show');
			
			/*$('#legs_reorder').modal('show');
		  jQuery.post(base_url+"org_transportation/create_legs/"+transport_id+"/",{legsArray:jsondata}, function( data ) {
				$('#legs_reorder').modal('hide');				
			});*/
			
			$.ajax({ 
					type:'POST',
					url:base_url+"org_transportation/create_legs/"+transport_id+"/",
					async:false,
					data:{
						legsArray:jsondata,
					}, 
					success:function(data) 
					{
						//console.log("HII12");
					},	
				});	
			
			//$('#transportleg_loader').modal('hide');
			var cname = 'edit_legs';
			var cvalue = '1';
			var exdays = '1';
			var d = new Date();
			d.setTime(d.getTime() + (exdays*24*60*60*1000));
			var expires = "expires="+ d.toUTCString();
			document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;domain=.doobert.com";
			window.location = base_url+'transport-create-legs/';	
		
	}
	else
	{
		return false;
	}
}

$(document).on('click','#cancel_g,#cancel_a,#cancel_o,#cancel_airline,.close-ground-leg,.close-airline-leg,.close-aviation-leg,.close-overnight-leg',function(){
	/*-----------Route legs in edit mode and user click on cancel start--------------*/
	/*if((this.id=="cancel_g" || this.class=='close-ground-leg') && edit_q!='' )
	{
		flag 	= '';
	}
	
	if((this.id=="cancel_a" || this.class=='close-aviation-leg' ) && edit_q!='')
	{
		flag 	= '';
			
	}
	
	if((this.id=="cancel_o" || this.class=='close-overnight-leg' ) && edit_q!='')
	{
		flag 	= '';
	}
	
	if((this.id=="cancel_airline" || this.class=='close-airline-leg') && edit_q!='' )
	{
		flag 	= '';	
	}*/
	$('.help-block').remove();
	$('.form-group').removeClass('has-error');
	flag 	= '';	
	edit_q = '';		
	document.getElementById("addlegs").reset();
	$("#address_display").modal('hide');
	$("#aviation_display").modal('hide');
	$("#overnight_display").modal('hide');
	$("#airline_transport_display").modal('hide');
	$("#clockface_2_modal").val('');
	$("#pickup_airport_clock").val('');
	$('#no_of_drivers_div').hide();
	$('#no_of_pilots_div').hide();
	$('#multiple_drivers_txt').val('');
	$('#multiple_pilots_txt').val('');
	$('#route_type_id').val('');
	$('#pre-assign_volunteer-driver-id,#deleteuid-driver1,#non-doobert-userid').val('0');
	$('#pre-assign_volunteer-pilot-id,#deleteuid-pilot,#non-doobertpilot-userid').val('0');
	$('#pre-assign_volunteer-overnight-id,#deleteuid-overnight,#non-doobertovernight-userid').val('0');
	$('#pre-assign_volunteer-airline-id,#deleteuid-airline,#non-doobertairline-userid').val('0');
	$("#leg_id").val('');
});	
jQuery(document).on('click','#save_legs,#save_draft,#save_only',function(e){
var action = $(this).attr("id");
	$('#upload_leg_f').val('');
		if(transport_type =='P' || transport_type =='RO')
		{
			if(action=='save_legs')
			{
				var new_date = new Date();
				if(transport_status =='1')
				{
					if(new Date(dt_target)<new Date())
					{
						alert("Transportation target date must be greater than current date.");
						return false;
					}
					
				}
				else
				{
						if(new Date(dt_pickup_date)< new Date(new_date.getFullYear(),new_date.getMonth(),new_date.getDate(),0,0,0,0) || new Date(dt_target)<new Date())
					{
						alert("Transportation target date and pick up date must be greater than or equal to the current date.");
						return false;
					}
					
				}
				
			}
		
		var g_leg = $('#address_display').css('display');
		var a_leg = $('#aviation_display').css('display');
		var o_leg = $('#overnight_display').css('display');
		 
		if(flag!='' || g_leg == 'block' || a_leg == 'block' || o_leg == 'block')
		{
			//alert("Update your current leg.");
			alert("Please scroll down to complete editing the currently selected leg.");
			return false;
		}
		
		var error_message = "";
		var last_error_message = "";
		var status = '0';
		if(myArray.length>0)
		{
			for(var j=0;j<myArray.length;j++)
			{
				if(myArray[j]['update_leg'] == 'delete')
				{
					status = '1';
				} else {
					status = '0';
					break;
				}		
			}
			if(status == '1')
			{
				alert("Please create legs.");
				return false;
			}	
		}
		else {
			alert("Please create legs.");
			return false;
		}
		renumber_table('#leg_table_body');
		if(myArray.length>0)
		{
			for(var i=0;i<myArray.length;i++)
			{
				if(myArray[i]['update_leg']!='delete')
				{
					if(myArray[i]['route_type_id']=='1') // Aviation
					{
						var pickup = myArray[i]['pickup_airport_clock'];
						var target = myArray[i]['dropoff_airport_clock'];
						var target1 = target.replace(" - ", " ");
						var pickup1 = pickup.replace(" - ", " ");
						if((new Date(dt_target)<new Date(pickup1) || new Date('<?php echo $dt_target;?>')<new Date(target1)) || (new Date(dt_pickup_date)>new Date(pickup1) || new Date(dt_pickup_date)>new Date(target1)))
						{
							error_message +="Please update leg "+(i+1)+" as per new transportation date. \n";
						}
					}
					else if(myArray[i]['route_type_id']=='0') // Aviation  // road
					{
						var pickup = myArray[i]['clockface_2_modal'];
						var target = myArray[i]['clockface_3_modal'];
						var target1 = target.replace(" - ", " ");
						var pickup1 = pickup.replace(" - ", " ");
						if((new Date(dt_target)<new Date(pickup1) || new Date(dt_target)<new Date(target1)) || (new Date(dt_pickup_date)>new Date(pickup1) || new Date(dt_pickup_date)>new Date(target1)))
						{
							error_message +="Please update leg "+(i+1)+" as per new transportation date. \n";
						}
					}
					
				}
			}
			
			if(error_message!='')
			{
				alert(error_message);
				return false;
			}
			
			$('#save_legs,#save_draft,#add_aviation_leg_g,#add_aviation_leg_a,#save_only,#cancel_only').hide();
			$('.add-additional-info').hide();
			
			if(action == 'save_legs')
			{
				$('#transport_loader').modal('show');
				
				/*setTimeout(function(){
				  $('#transport_loader').modal('hide')
				}, 10000);*/
			}
			
			if(action == 'save_only')
			{
				$('#transport_loader_save_only').modal('show');
				setTimeout(function(){
				  $('#transport_loader_save_only').modal('hide')
				}, 10000);
			}
		
			var jsondata = JSON.stringify(myArray); 
			$.ajax({
				url: base_url+'transport-create-legs/',
				type: 'POST',
				data: { data_val:jsondata,action:action,transport_id:transport_id,org_id:org_id},
				success: function(result) {
					
					$('#transport_loader').modal('hide');
					
					
					if(action == 'save_draft')
					  {
							$('#portlet-config').modal('show');         
							$('#save_legs,#save_draft,#add_aviation_leg_g,#add_aviation_leg_a,#save_only').show();
							$('.add-additional-info').show();       
					  }
					  else
					{
						window.location.href=base_url+"org-transportation-scheduled/"+transport_id;
				    }
							   
					//window.location.href="<php echo base_url()."org-transportation-scheduled/"?>";
				}
			});
		}
		else
		{
			alert("Please create legs.");
			return false;
		}
		 }else{ 
			$('#save_legs,#save_draft,#add_aviation_leg_g,#add_aviation_leg_a,#save_only,#cancel_only').hide();
			$('.add-additional-info').hide();
			if(action == 'save_legs')
			{
				$('#transport_loader').modal('show');
				//$('#transport_loader').modal('show',10000);
				setTimeout(function(){
				  $('#transport_loader').modal('hide')
				}, 10000);
			}

			if(action == 'save_only')
			{
				$('#transport_loader_save_only').modal('show');
				setTimeout(function(){
				  $('#transport_loader_save_only').modal('hide')
				}, 10000);
			}
			
			
			
			jQuery.post(base_url+"transport-create-legs/",{data_val:myArray,transport_type:"D",action:action,transport_id:transport_id,org_id:org_id}, function( data ) {
			
			$('#transport_loader').modal('hide');
			//added by amit

            if(action == 'save_draft')
            {
                  $('#portlet-config').modal('show');         
                  $('#save_legs,#save_draft,#add_aviation_leg_g,#add_aviation_leg_a,#save_only').show();
                  $('.add-additional-info').show();       
            }
            else
            {
                  window.location.href=base_url+"org-transportation-scheduled/"+transport_id;      
            }
			
			});
		 }
});

$(document).on('click','#c_date',function(){
  $('#portlet-config').modal('hide');
});
$(document).on('click','#c_date1',function()
{
	if(transport_type =='D')
	{
		window.location.href=base_url+"org_transportation/request_assigned_to_me/";
	} else if(transport_type =='RO')
	{
		window.location.href=base_url+"org_transportation/draft_route_transport/";
	} else {	
		window.location.href=base_url+"org_transportation/draft_transport/";
	}
});

$(document).on('click','#upload_leg_file',function(event) {
	event.preventDefault();
	var action = $(this).attr("id");
	$('#upload_leg_f').val('');
	var error_msg = '';
	
	if($('#leg_upload').val() == '')
	{
	alert('Please select file to upload.');
	return false;
	}
	
	if($('#leg_upload').val()!='') {
			$("#popup_leg_upload_cancel").attr("disabled",true);
			$("#popup_leg_upload_cancel").hide();
			$("#popup_leg_upload_close").hide();
			var fsize1 = $('#leg_upload')[0].files[0].size;
			var fname1 = $('#leg_upload')[0].files[0].name;
			var ftype1 = $('#leg_upload')[0].files[0].type;
			
			if ( $.browser.msie ) {
				//alert( $.browser.version );
				// Use a regular expression to trim everything before final dot
				 var extension = $('#leg_upload').val().replace(/^.*\./, '');
				 //alert(extension);
				   
				 if(extension != "" && extension != "xls" && extension != "xlsx" && extension != "csv")
				 {
					error_msg+='Upload file format is invalid\n';
				 }
				 else{
					//error_msg+='correct file format\n';
				 }
			}
			else
			{
				if(fsize1 > 1048576) {
					error_msg+='Upload file must be less than 1MB\n';
				}
				
				if(ftype1 != 'text/comma-separated-values' && ftype1 != 'application/vnd.ms-excel' && ftype1 != 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' && ftype1 != '.csv') {
					error_msg+='Upload file format is invalid\n';
				}
			}			
			
			if(error_msg != '') {
				alert(error_msg);
				return false;
			}
			$('#upload_leg_f').val('1');
			$('#upload_leg_div').modal('hide');
			$('#loader').show();
			$('#upload_legs_by_file').submit();
	}

});
function initialize() {
// create the map
	//alert('display map');
	 return Doobert.components.transportation_route.Base = flight.component(function () {
            return this.after("initialize", function () {
                var t = this;
                return void 0 !== Doobert.components.Overlay && Doobert.components.Overlay.attachTo("#main-transportation-route"), 
				 this.trigger("map.initialize", {
                    routeMapSelector: "#route-map"
                })
            })
        }), Doobert.components.transportation_route.Base.attachTo("#main-transportation-route")
	}

$("#main-transportation-route").attr("style", "position:relative; display: none;"); 	
$(document).on('click','.map',function() {
 		if($(".transport-view-map1").html() == '<i class="material-icons">map</i> View Map')
		{
			$(".transport-view-map1").html('<i class="material-icons">map</i> Hide Map');
			$(".transport-view-map1").attr('title','Hide Map');	 
			$("#main-transportation-route").attr("style", "position:relative; display: block;"); 	
			initialize();
			
		}
		else if($(".transport-view-map1").html() == '<i class="material-icons">map</i> Hide Map')
		{
			//$("#main-transportation-route").height($("#leftheight").height());
			$(".transport-view-map1").html('<i class="material-icons">map</i> View Map');
			$(".transport-view-map1").attr('title','View Map');
			$(".view_map_tg").attr('id' , 'grid-view');
			$("#main-transportation-route").attr("style", "position:relative; display: none;"); 
		}
});	

$(document).on('click','#multiple_drivers' ,function() {

var multi_drive = $('#multiple_drivers').prop('checked');
if(multi_drive){
	$('#multiple_drivers_txt').val('1');
	$('#no_of_drivers_div').show();
	$('#meeting_location_div').show();
}else{
	$('#no_of_drivers_div').hide();
	$('#multiple_drivers_txt').val('');
	$('#no_of_drivers').val('');
	$('#meeting_location').val('');
}

});

$(document).on('click','#multiple_pilots',function() {

var multi_pilot = $('#multiple_pilots').prop('checked');

	if(multi_pilot){
		$('#multiple_pilots_txt').val('1');
		$('#no_of_pilots_div').show();
		$('#pilot_meeting_location_div').show();
	}else{
		$('#no_of_pilots_div').hide();
		$('#no_of_pilots').val('');
		$('#multiple_pilots_txt').val('');
}

});

function edit_airline_legs(q,e)
{
	if(add_flg!='' && edit_q=='')
	{
		$("#address_display").hide();
		$("#aviation_display").hide();	
		$("#overnight_display").hide();	
	}
	if(flag=='')
	{
		if($("#tr_"+q).prev().attr('id'))
		{
			flag 	= $("#tr_"+q).prev().attr('id');
		}
		else
		{	
			var tr_no = q-1;		
			flag 	= "tr_"+tr_no;	
		}
		//console.log()
		edit_q	= q;	//$('#tr_'+ q).fadeOut('slow'); 
		var trId = e.closest('tr').prop('id');
		editedTrid = e.closest('tr').prop('id');
		tr_cnt = trId.substr(trId.indexOf("_") + 1);
		/*if($( window ).width() <= 767)
		{
			e.closest('table').remove();
		} else {
		$('#'+trId).remove();
		}*/
		var a = q-1;
		//console.log(myArray);
	
		
			var dest_airline = myArray[a].dropoff_city+' ('+myArray[a].dropoff_street+') ';
			
			$("#dropoff_airport_identifer").val(stripslashes(myArray[a].dropoff_street));
			$("#drop_base_airport").val(stripslashes(dest_airline));
			$("#dropoff_airline_clock").val(myArray[a].clockface_3_modal);
			$("#dropoff_airline_zone").val(myArray[a].dropoff_zone);
			
			var source_airline = myArray[a].pickup_city+' ('+myArray[a].pickup_street+') ';
			
			$("#pickup_airport_identifer").val(stripslashes(myArray[a].pickup_street));
			$("#pick_base_airport").val(stripslashes(source_airline));
			$("#pickup_airline_clock").val(myArray[a].clockface_2_modal);
			$("#pickup_airline_zone").val(myArray[a].pickup_zone);
			$("#leg_id").val(myArray[a].leg_id);
			
			if(myArray[a].in_user_id!='' && myArray[a].st_user_name!='')
			{	
				$('#pre-assign_volunteer-airline').val(stripslashes(myArray[a].st_user_name));
				$('#pre-assign_volunteer-airline-id').val(stripslashes(myArray[a].in_user_id));
				$('#deleteuid-airline').val(stripslashes(myArray[a].in_user_id));
			} else {
				if(myArray[a].non_doobert_userid!='' && myArray[a].nondoobert_user_name!='')
				{
					$('#pre-assign_volunteer-airline').val(stripslashes(myArray[a].nondoobert_user_name));
					$('#non-doobertairline-userid').val(stripslashes(myArray[a].non_doobert_userid));
				}	
			}
		
		//document.getElementById("dropoff_zone").value = myArray[a].dropoff_zone;
		//document.getElementById("pickup_zone").value = myArray[a].pickup_zone;
		
		$("#airline_meeting_location").val(stripslashes(myArray[a].meeting_location));
		
		$("#pickup_airline_clock_year").val(stripslashes(myArray[a].pick_year));
		$("#dropoff_airline_clock_year").val(stripslashes(myArray[a].drop_year));
		
		$("#route_type_id").val("3");
		from_date_setup = myArray[a].clockface_2_modal;
		to_date_setup   = myArray[a].clockface_3_modal;
		//$('#airline_transport_display').show();
	
		$('#airline_transport_display').modal('show');
	
	
	}
	else
	{
		//alert("Update your current leg.");
		alert("Please scroll down to complete editing the currently selected leg.");
	}
}

function delete_airline_legs(q,e)
{
	if(confirm("Are you sure, Do you want to delete this leg?"))
	{
		$('#leg_deleted').val(1);
		//$('#tr_'+ q).remove();
		
		/*var trId = e.closest('tr').prop('id');
		tr_cnt = trId.substr(trId.indexOf("_") + 1);
		$('#'+trId).remove();*/
		
		if($( window ).width() <= 767)
		{
			e.closest('table').remove();	
		} else {
			var trId = e.closest('tr').prop('id');
			tr_cnt = trId.substr(trId.indexOf("_") + 1);
			$('#'+trId).remove();	
		}
		
		var a = q-1;
		
		var leg_id = myArray[a].leg_id;
		
		var in_distance_covered = jQuery("#distance_covered").val() ;
		var distance_total = jQuery("#distance_total").val() ;
		var distance_remaining = jQuery("#distance_remaining").val() ;
		
		//var distance_remain_total = jQuery("#distance_remain").html() ;
		//var distance_remain_total_array = distance_remain_total.split(" ");
		
		var delete_leg	 = new Array();
		delete_leg = myArray[a];
		
		var route_type = myArray[a].route_type_id;
		
		var prev_sort_order = myArray[a].in_sort_order;
	
		var new_sort_order = myArray[a].in_sort_order;
		delete myArray[a];		
			
		myArray[a]=({"leg_id":leg_id,"update_leg":"delete"});
		
		legsArray = [];
		legsArray[0] = ({"leg_id":leg_id});
		if($( window ).width() <= 767)
		{	
					for(var i=q;i<myArray.length;i++)
					{
						if(myArray[i]['leg_id']!='' && myArray[i]['update_leg'] != 'delete')
						{	
							myArray[i]['in_sort_order'] = new_sort_order;
							new_sort_order++;
						}	
					}	
		 } else {	 
			renumber_table('#leg_table_body');
		 }
		 
		 //renumber_table('#leg_table_body');
		 	var jsondata = JSON.stringify(myArray);
			$('#legs_reorder').modal('show');
		  /*jQuery.post(base_url+"org_transportation/delete_airline_leg/"+transport_id+"/",{legsid:leg_id,jsondata:jsondata}, function( data ) {
				//$('#legs_reorder').modal('hide');				
			});*/
			
			$.ajax({ 
					type:'POST',
					url:base_url+"org_transportation/delete_airline_leg/"+transport_id+"/",
					async:false,
					data:{
						legsid:leg_id,
						jsondata:jsondata
					}, 
					success:function(data) 
					{
						//console.log("HII12");
					},	
				});	
			
			//$('#transportleg_loader').modal('hide');
			var cname = 'edit_legs';
			var cvalue = '1';
			var exdays = '1';
			var d = new Date();
			d.setTime(d.getTime() + (exdays*24*60*60*1000));
			var expires = "expires="+ d.toUTCString();
			document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;domain=.doobert.com";
			window.location = base_url+'transport-create-legs/';
		
	}
	else
	{
		return false;
	}
}

$(document).on('click','#airline_submit',function(){	

	if( $('#addlegs').valid() == false) {
		return false;
	} else {
		
		//$("#pickup_airline_clock_year").val(stripslashes(myArray[a].pick_year));
		//$("#dropoff_airline_clock_year").val(stripslashes(myArray[a].drop_year));
		
		var to_date = $('#dropoff_airline_clock').val();
		var from_date = $('#pickup_airline_clock').val();
		var to_date_split = to_date.split('-');
		var from_date_split = from_date.split('-');
	  
		var frm_year = $('#pickup_airline_clock_year').val();
		var to_year = $('#dropoff_airline_clock_year').val();
	  
		var start_time_date = new Date(from_date_split[0]);
		var end_time_date = new Date(to_date_split[0]);
	  
		var end_date = new Date(to_year, end_time_date.getMonth(), end_time_date.getDate()); 
		var start_date = new Date(frm_year, start_time_date.getMonth(), start_time_date.getDate()); 
		
		var volunteer_name = $('#pre-assign_volunteer-airline').val().replace(/\s/g,'');
		
		if (start_date > end_date) {
			alert("Start Date is greather than End Date.");
			return false;
		} 
		if (end_date < start_date) {
			alert("End Date is less than Start Date.");
			 
			return false;
		}
	  //var valid_legs =  $('#addlegs').valid() ;
		$('#transportleg_loader').modal('toggle');
		$("#airline_transport_display").modal('toggle');
		
		if(edit_q!='')
		{
			edit_sort_order = myArray[edit_q-1].in_sort_order;	
			delete myArray[edit_q-1];	
		}
	  
		
		
		var pickup_address  =  '';
		var dropoff_address  = '';
		
		
		var start_time 		 = $("#pickup_airline_clock").val();	
			start_time 		+= " - "+$("#pickup_airline_zone").val();	
		var end_time 		 = $("#dropoff_airline_clock").val();	
			end_time 		+= " - "+$("#dropoff_airline_zone").val();
	
		var leg_id 			= $("#leg_id").val();	
		var update_leg 		= "update";		
	    var b;	
		
		var pick_dropoff    = pickup_address+'<i class="material-icons">keyboard_backspace</i>'+dropoff_address; 	
		
		var start_end_time = start_time+'<br>'+end_time;	
		
		var meeting_location = $("#airline_meeting_location").val();
		
		
		legsArray = [];
		
			var i 		= edit_q-1;
			var index 	= edit_q;	
			
			var sort_order = index;
			
		if(myArray[i-1])
		{
			if(typeof myArray[i-1].in_sort_order === 'undefined')
			{
					sort_order = 1;				
			}else{
					sort_order = parseInt(myArray[i-1].in_sort_order) + parseInt(1);
			}
		}

		var sort_order_max = parseInt(edit_sort_order) + parseInt(1);
		var order_id = edit_sort_order;
		var user_id = $('#pre-assign_volunteer-airline-id').val();
		
		myArray[i]=({"pickup_street":addslashes($("#pickup_airport_identifer").val()),"pickup_city":addslashes($("#pickup_city").val()),"pickup_state":addslashes($("#pickup_state").val()),"pickup_zip":addslashes($("#pickup_zip").val()),"pickup_country":addslashes($("#pickup_country").val()),"clockface_2_modal":$("#pickup_airline_clock").val(),"pickup_zone":$("#pickup_airline_zone").val(),"dropoff_street":addslashes($("#dropoff_airport_identifer").val()),"dropoff_city":addslashes($("#dropoff_city").val()),"dropoff_state":addslashes($("#dropoff_state").val()),"dropoff_zip":addslashes($("#dropoff_zip").val()),"dropoff_country":addslashes($("#dropoff_country").val()),"clockface_3_modal":$("#dropoff_airline_clock").val(),"dropoff_zone":$("#dropoff_airline_zone").val(),"leg_id":$("#leg_id").val(),"route_type":'airline',"route_type_id":3,"pickup_airport":addslashes($("#pickup_airport").val()),"pickup_airport_clock":$("#pickup_airport_clock").val(),"pickup_airport_zone":$("#pickup_airport_zone").val(),"dropoff_airport":addslashes($("#dropoff_airport").val()),"dropoff_airport_clock":$("#dropoff_airport_clock").val(),"dropoff_airport_zone":$("#dropoff_airport_zone").val(),"dropoff_airport_state":addslashes($("#dropoff_airport_state").val()),"dropoff_airport_city":addslashes($("#dropoff_airport_city").val()),"pickup_airport_state":addslashes($("#pickup_airport_state").val()),"pickup_airport_city":addslashes($("#pickup_airport_city").val()),"update_leg":"update","meeting_location":addslashes($("#meeting_location").val()),"no_of_drivers":addslashes($("#no_of_drivers").val()),"multiple_drivers":addslashes($("#multiple_drivers_txt").val()),"in_sort_order":edit_sort_order,'pick_year':addslashes($('#pickup_airline_clock_year').val()),'drop_year':addslashes($('#dropoff_airline_clock_year').val())});
		
         legsArray=({"leg_id":$("#leg_id").val(),"pickup_airport":addslashes($("#pickup_airport_identifer").val()),"pickup_airline_clock":$("#pickup_airline_clock").val(),"pickup_airline_zone":$("#pickup_airline_zone").val(),"dropoff_airport":addslashes($("#dropoff_airport_identifer").val()),"dropoff_airline_clock":$("#dropoff_airline_clock").val(),"dropoff_airline_zone":$("#dropoff_airline_zone").val(),"meeting_location":addslashes($("#airline_meeting_location").val()),"in_sort_order":edit_sort_order,'user_id':addslashes($('#pre-assign_volunteer-airline-id').val()),'deleted_user_id':addslashes($('#deleteuid-airline').val()),'non_doobert_userid':addslashes($('#non-doobertairline-userid').val()),'volunteer_name':addslashes(volunteer_name),'pick_year':addslashes($('#pickup_airline_clock_year').val()),'drop_year':addslashes($('#dropoff_airline_clock_year').val())});
			//legsArray[0] =({"pickup_street":addslashes($("#pickup_street").val()),"pickup_city":addslashes($("#pickup_city").val()),"pickup_state":addslashes($("#pickup_state").val()),"pickup_zip":addslashes($("#pickup_zip").val()),"pickup_country":addslashes($("#pickup_country").val()),"clockface_2_modal":$("#clockface_2_modal").val(),"pickup_zone":$("#pickup_zone").val(),"dropoff_street":addslashes($("#dropoff_street").val()),"dropoff_city":addslashes($("#dropoff_city").val()),"dropoff_state":addslashes($("#dropoff_state").val()),"dropoff_zip":addslashes($("#dropoff_zip").val()),"dropoff_country":addslashes($("#dropoff_country").val()),"clockface_3_modal":$("#clockface_3_modal").val(),"dropoff_zone":$("#dropoff_zone").val(),"leg_id":$("#leg_id").val(),"route_type":$("#route_type").val(),"route_type_id":$("#route_type_id").val(),"pickup_airport":addslashes($("#pickup_airport").val()),"pickup_airport_clock":$("#pickup_airport_clock").val(),"pickup_airport_zone":$("#pickup_airport_zone").val(),"dropoff_airport":addslashes($("#dropoff_airport").val()),"dropoff_airport_clock":$("#dropoff_airport_clock").val(),"dropoff_airport_zone":$("#dropoff_airport_zone").val(),"dropoff_airport_state":addslashes($("#dropoff_airport_state").val()),"dropoff_airport_city":addslashes($("#dropoff_airport_city").val()),"pickup_airport_state":addslashes($("#pickup_airport_state").val()),"pickup_airport_city":addslashes($("#pickup_airport_city").val()),"update_leg":"update","meeting_location":addslashes($("#meeting_location").val()),"no_of_drivers":addslashes($("#no_of_drivers").val()),"multiple_drivers":addslashes($("#multiple_drivers_txt").val()),"in_sort_order":edit_sort_order});
	
			
			legsArray = JSON.stringify(legsArray);
			
	        	$.ajax({
								type:'POST',
								url:base_url+"org_transportation/update_airline_legs/"+transport_id+"/",
								async:false,
								data:{
									legsArray:legsArray,action:"save_legs"
								}, 
								
								success:function( data ) {
									//console.log(data);
									data = jQuery.parseJSON(data)
									//console.log(data.st_from_city);
									
									if(user_id == 'n-d-u')
									{
										$('#non_doobert_user_transport_leg_id').val(data);
									}	
									/*myArray[i].pickup_street = 	data.st_from_street;
									myArray[i].pickup_city = 	data.st_from_city;
									myArray[i].pickup_state = 	data.st_from_state;
									myArray[i].pickup_country = data.st_from_country;
									myArray[i].dropoff_street = data.st_to_street;
									myArray[i].dropoff_city = 	data.st_to_city;
									myArray[i].dropoff_state = 	data.st_to_state;
									myArray[i].dropoff_country = data.st_to_country;
									var trid = $('tr[data-sort-order="'+index+'"]').attr('id');
									$('#'+trid).attr('data-leg-id',data.leg_id);
									var html_element = '';
									 html_element += '<p> From: '+data.st_from_city+' ('+data.st_from_street+')';
									 html_element += ' <i class="material-icons">keyboard_backspace</i>';
									 html_element += ' To: '+data.st_to_city+' ('+data.st_to_street+') </p>';
									console.log(html_element);
									$('#'+trid).children('.pickdrop').html(html_element);
									$('#transportleg_loader').modal('hide');*/
									//$('#'+trid).children('td .pickdrop').html('<p> From: '+data.st_from_city+' ('+data.st_from_street+') '+'<i class="material-icons">keyboard_backspace</i> To:'+data.st_to_city+' ('+data.st_to_street+') '+'</p>');
								},
							});	
			
			
			if(user_id == 'n-d-u')
			{
				$('#assign-nondoobert-user').modal('show');
			} else {
			var cname = 'edit_legs';
			var cvalue = '1';
			var exdays = '1';
			var d = new Date();
			d.setTime(d.getTime() + (exdays*24*60*60*1000));
			var expires = "expires="+ d.toUTCString();
			document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;domain=.doobert.com";
			window.location = base_url+'transport-create-legs/';
			}
			
			/*var cname = 'edit_legs';
			var cvalue = '1';
			var exdays = '1';
			var d = new Date();
			d.setTime(d.getTime() + (exdays*24*60*60*1000));
			var expires = "expires="+ d.toUTCString();
			document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
			window.location = base_url+'transport-create-legs/';*/
			
						
		return false;
	}
});

$('#drop_base_airport').autocomplete({
		 source: function (request, response)
   		 {
			request.term = $.trim(request.term);
			var str	= request.term;
			var letters = /^[a-zA-Z ]+$/;	
			if(str.match(letters))
			{
				request.term = str; 
			} else {
				str = str.toUpperCase();
				request.term = str.replace(/\s/g, ''); 
			}	 
			$.ajax({
				url: base_url+"org_transportation/airport_base/" ,
				dataType: "json",
				data:
				{
					term: request.term
				},
				success: function (data)
				{	
					if(data=="1")
					{
						window.location.href=base_url;
					}
					if(1)
					{
						response(data);
					}
				}
			});
  	  	}, 
		minLength:1,
		open: function() { $('.ui-menu').width($("#drop_base_airport" ).width()) },
		focus: function( event, ui ) 
		{
			var id = ui.item.label;
			var name = ui.item.value;
			$("#drop_base_airport" ).val(id);
			$('#dropoff_airport_identifer').val(name);
			return false;
		},     
		select: function( event, ui ) 
		{
			var id = ui.item.label;
			var name = ui.item.value;
			$("#drop_base_airport" ).val(id);
			$('#dropoff_airport_identifer').val(name);
			return false;
		}			
	});


$('#pick_base_airport').autocomplete({
		source: function (request, response)
   		{
			request.term = $.trim(request.term);
			var str	= request.term;
			var letters = /^[a-zA-Z ]+$/;	
			if(str.match(letters))
			{
				request.term = str; 
			} else {
				str = str.toUpperCase();
				request.term = str.replace(/\s/g, ''); 
			}	 
			$.ajax(
			{
				url: base_url+"org_transportation/airport_base/" ,
				dataType: "json",
				data:
				{
					term: request.term
				},
				success: function (data)
				{
					if(data=="1")
					{
						window.location.href=base_url;
					}
					if(1)
					{
						response(data);
					}
				}
			});
  	  	}, 
		minLength:1,
		open: function() { $('.ui-menu').width($("#pick_base_airport" ).width()) },
		focus: function( event, ui ) 
		{
				var id = ui.item.label;
				var name = ui.item.value;
				$("#pick_base_airport" ).val(id);
				$("#pickup_airport_identifer").val(name);
				return false;
		},     
		select: function( event, ui ) 
		{
				var id = ui.item.label;
				var name = ui.item.value;
				$("#pick_base_airport" ).val(id);
				$("#pickup_airport_identifer").val(name);
				return false;
		}
	});
	
$(document).on('change','#pick_base_airport',function(){
var selected_zipcode = $.trim($(this).val());


	if(selected_zipcode!='')
	{
	  $.ajax({
            url: base_url+"org_transportation/airport_base/" ,
            dataType: "json",
            data:
            {
                term: selected_zipcode,
            },
            success: function (data)
            {
				if(data)
				{
					var name = data[0].value;
					$( "#pick_base_airport" ).val(data[0].label);
					$("#pickup_airport_identifer").val(name);
				}
				else
				{
					if(data == null || data === '')
					{
						alert('Please enter valid from location');
						$("#pick_base_airport").val('');
						$("#pickup_airport_identifer").val('');
					}
				}
				
            }
        });		
	} else 
	{
			alert('Please enter valid fromlocation');
			$("#pick_base_airport").val('');
	}	 

});

$(document).on('change','#drop_base_airport',function(){
var selected_zipcode = $.trim($(this).val());


	if(selected_zipcode!=''){
	  $.ajax({
            url: base_url+"org_transportation/airport_base/" ,
            dataType: "json",
            data:
            {
                term: selected_zipcode,
            },
            success: function (data)
            {
				if(data)
				{
					$( "#drop_base_airport" ).val(data[0].label);
					$('#dropoff_airport_identifer').val(data[0].value);
				}
				else
				{
					if(data == null || data === '')
					{
						alert('Please enter valid to location');
						$("#drop_base_airport").val('');
						$('#dropoff_airport_identifer').val('');
					}
				}	
            }
        });		
	} else {
			alert('Please enter valid to location');
			$("#drop_base_airport").val('');
	}	 	 

});	

$(document).on("keydown.autocomplete","#pre-assign_volunteer-driver",function(e){
	$('#pre-assign_volunteer-driver').autocomplete({
		source: function (request, response)
   		 {
			request = $.trim(request.term);
			$.ajax(
			{
				url: base_url+"org_transportation/get_all_driver/" ,
				dataType: "json",
				data:
				{
					term: request
				},
				success: function (data)
				{
					if(data!='0')
					{
						response(data);
					} else {
					  if(data=='0')
					  {	  
						$("#pre-assign_volunteer-driver").val(' ');
						$("#pre-assign_volunteer-driver-id" ).val('0');
					  }  	
					}
				}
			});
  	  	},
		minLength:1,
		open: function() 
		{ 
			$('.ui-menu').width($("#pre-assign_volunteer-driver" ).width()) 
			 /*if (navigator.userAgent.match(/iPad/) || navigator.userAgent.match(/iPhone/)) {
                          $('.ui-autocomplete').off('menufocus hover mouseover');
                      }*/
		},
		focus: function( event, ui ) {
			var id = ui.item.label;
			var name = ui.item.name;
			var user_id =  ui.item.value;
			/*var phone_number =  ui.item.primary_phone;
			if(phone_number == '')
			{
				$("#pre-assign_volunteer-driver").val(' ');
				$("#pre-assign_volunteer-driver-id" ).val('0');
				alert('This User has not submitted phone number in profile page');
			} else 
			{*/
				$("#pre-assign_volunteer-driver" ).val(name);
				$("#pre-assign_volunteer-driver-id" ).val(user_id);
			//}
			return false;
		},     
		select: function( event, ui ) {
			var id = ui.item.label;
			var name = ui.item.name;
			var user_id =  ui.item.value;
			var phone_number =  ui.item.primary_phone;
			if(phone_number == '')
			{
				$("#pre-assign_volunteer-driver").val(' ');
				$("#pre-assign_volunteer-driver-id" ).val('0');
				alert('This user has not submitted phone number in general profile page');			
			} else { 
				$("#pre-assign_volunteer-driver" ).val(name);
				$("#pre-assign_volunteer-driver-id" ).val(user_id);
			}
			return false;
		},
		appendTo: ".assign_volunteer-driver",
	});	
});

$(document).on('change','#pre-assign_volunteer-driver',function()
{
		var term = $('#pre-assign_volunteer-driver').val().replace(/\s/g,'');
		if(term!='')
		{	
	  $.ajax({
            url: base_url+"org_transportation/get_all_driver/",
            dataType: "json",
            data:
            {
                term: term,
            },
            success: function (data)
            {
				if(data)
				{
					var id = data[0].label;
					var name = data[0].name;
					var user_id =  data[0].value;
					if(data[0].primary_phone == '')
					{
						$("#pre-assign_volunteer-driver").val(' ');
						$("#pre-assign_volunteer-driver-id" ).val('0');
						alert('This user has not submitted phone number in general profile page');
					} else {
						$("#pre-assign_volunteer-driver").val(name);
						$("#pre-assign_volunteer-driver-id").val(user_id);
					}
				}
				else
				{
					if(data == null || data === '' || data == '0')
					{
						$("#pre-assign_volunteer-driver").val(' ');
						$("#pre-assign_volunteer-driver-id" ).val('0');
					}
				}
			}
		});
		} else {
			$("#pre-assign_volunteer-driver").val(' ');
			$("#pre-assign_volunteer-driver-id" ).val('0');
		}	
});

$(document).on("keydown.autocomplete","#pre-assign_volunteer-pilot",function(e){
	$('#pre-assign_volunteer-pilot').autocomplete({
		source: function (request, response)
   		 {
			request = $.trim(request.term);
			$.ajax(
			{
				url: base_url+"org_transportation/get_all_pilot/" ,
				dataType: "json",
				data:
				{
					term: request
				},
				success: function (data)
				{
					if(data=="1")
					{
						//window.location.href=base_url;
					}
					if(data!='0')
					{
						response(data);
					} else {
					  if(data=='0')
					  {	  
						$("#pre-assign_volunteer-pilot").val(' ');
						$("#pre-assign_volunteer-pilot-id" ).val('0');
					  }  	
					}
					
				}
			});
  	  	},
		minLength:1,
		open: function() { $('.ui-menu').width($("#pre-assign_volunteer-pilot" ).width()) },
		focus: function( event, ui ) {
			var id = ui.item.label;
			var name = ui.item.name;
			var user_id =  ui.item.value;
			/*var phone_number =  ui.item.primary_phone;
			if(phone_number == '')
			{
				$("#pre-assign_volunteer-pilot").val(' ');
				$("#pre-assign_volunteer-pilot-id" ).val('0');
				alert('This User has not submitted phone number in profile page');
			} else {*/
				$("#pre-assign_volunteer-pilot").val(name);
				$("#pre-assign_volunteer-pilot-id" ).val(user_id);
			//}
				return false;
		},     
		select: function( event, ui ) {
			var id = ui.item.label;
			var name = ui.item.name;
			var user_id =  ui.item.value;
			var phone_number =  ui.item.primary_phone;
			if(phone_number == '')
			{
				$("#pre-assign_volunteer-pilot").val(' ');
				$("#pre-assign_volunteer-pilot-id" ).val('0');
				alert('This user has not submitted phone number in general profile page');
			} else {
				$("#pre-assign_volunteer-pilot").val(name);
				$("#pre-assign_volunteer-pilot-id").val(user_id);
			}
			return false;
		},
		appendTo: ".assign_volunteer-pilot",
	});	
});


	$(document).on('change','#pre-assign_volunteer-pilot',function()
	{
		var term = $('#pre-assign_volunteer-pilot').val().replace(/\s/g,'');
		if(term!='')
		{
		$.ajax({
            url: base_url+"org_transportation/get_all_pilot/",
            dataType: "json",
            data:
            {
                term: term,
            },
            success: function (data)
            {
				if(data)
				{
					var id = data[0].label;
					var name =data[0].name;
					var user_id =  data[0].value;
					if(data[0].primary_phone == '')
					{
						$("#pre-assign_volunteer-pilot").val(' ');
						$("#pre-assign_volunteer-pilot-id" ).val('0');
						alert('This user has not submitted phone number in general profile page');
					} else {
						$("#pre-assign_volunteer-pilot").val(name);
						$("#pre-assign_volunteer-pilot-id").val(user_id);
					}
				}
				else
				{
					if(data == null || data === '' || data == '0')
					{
						$("#pre-assign_volunteer-pilot").val(' ');
						$("#pre-assign_volunteer-pilot-id" ).val('0');
					}
				}
			}
		});
		} else {
			$("#pre-assign_volunteer-pilot").val(' ');
			$("#pre-assign_volunteer-pilot-id" ).val('0');
		}		
			
  
});

$(document).on("keydown.autocomplete","#pre-assign_volunteer-overnight",function(e){
	$('#pre-assign_volunteer-overnight').autocomplete({
		source: function (request, response)
   		 {
			request = $.trim(request.term);
			$.ajax(
			{
				url: base_url+"org_transportation/get_all_users/" ,
				dataType: "json",
				data:
				{
					term: request
				},
				success: function (data)
				{
					
					if(data=="1")
					{
						//window.location.href=base_url;
					}
					if(data!='0')
					{
						response(data);
					} else {
					  if(data=='0')
					  {	  
						$("#pre-assign_volunteer-overnight").val(' ');
						$("#pre-assign_volunteer-overnight-id" ).val('0');
					  }  	
					}
				}
			});
  	  	},
		minLength:1,
		open: function() { $('.ui-menu').width($("#pre-assign_volunteer-overnight" ).width()) },
		focus: function( event, ui ) {
			var id = ui.item.label;
			var name = ui.item.name;
			var user_id =  ui.item.value;
			/*var phone_number =  ui.item.primary_phone;
			if(phone_number == '')
			{
				$("#pre-assign_volunteer-overnight").val(' ');
				$("#pre-assign_volunteer-overnight-id" ).val('0');
				alert('This User has not submitted phone number in profile page');
			} else {*/
				$("#pre-assign_volunteer-overnight").val(name);
				$("#pre-assign_volunteer-overnight-id" ).val(user_id);
			//}
			return false;
		},     
		select: function( event, ui ) {
			var id = ui.item.label;
			var name = ui.item.name;
			var user_id =  ui.item.value;
			var phone_number =  ui.item.primary_phone;
			if(phone_number == '')
			{
				$("#pre-assign_volunteer-overnight").val(' ');
				$("#pre-assign_volunteer-overnight-id" ).val('0');
				alert('This user has not submitted phone number in general profile page');
			} else {
			$("#pre-assign_volunteer-overnight").val(name);
			$("#pre-assign_volunteer-overnight-id").val(user_id);
			}
			return false;
		},
		appendTo: ".assign_volunteer-overnight",
	});	
});

	$(document).on('change','#pre-assign_volunteer-overnight',function()
	{
		var term = $('#pre-assign_volunteer-overnight').val().replace(/\s/g,'');
		if(term!='')
		{
		$.ajax({
            url: base_url+"org_transportation/get_all_users/",
            dataType: "json",
            data:
            {
                term: term,
            },
            success: function (data)
            {
				if(data)
				{
					var id = data[0].label;
					var name = data[0].name;
					var user_id =  data[0].value;
					if(data[0].primary_phone == '')
					{
						$("#pre-assign_volunteer-overnight").val(' ');
						$("#pre-assign_volunteer-overnight-id" ).val('0');
						alert('This user has not submitted phone number in general profile page');
					} else {
						$("#pre-assign_volunteer-overnight").val(name);
						$("#pre-assign_volunteer-overnight-id").val(user_id);
					}
				}
				else
				{
					if(data == null || data === '' || data == '0')
					{
						$("#pre-assign_volunteer-overnight").val(' ');
						$("#pre-assign_volunteer-overnight-id" ).val('0');
					}
				}
			}
		});
		} else {
			$("#pre-assign_volunteer-overnight").val(' ');
			$("#pre-assign_volunteer-overnight-id" ).val('0');
		}		
			
  
	});
	
	$(document).on("keydown.autocomplete","#pre-assign_volunteer-airline",function(e){
	$('#pre-assign_volunteer-airline').autocomplete({
		source: function (request, response)
   		 {
			request = $.trim(request.term);
			$.ajax(
			{
				url: base_url+"org_transportation/get_all_airlinebases/" ,
				dataType: "json",
				data:
				{
					term: request
				},
				success: function (data)
				{
					if(data=="1")
					{
						//window.location.href=base_url;
					}
					if(data!='0')
					{
						response(data);
					} else {
					  if(data!='0')
					  {	  
						$("#assign_user_name-pilot1").val('');
						$("#pre-assign_volunteer-airline-id" ).val('0');
					  }  	
					}
					
				}
			});
  	  	},
		minLength:1,
		open: function() { $('.ui-menu').width($("#pre-assign_volunteer-airline" ).width()) },
		focus: function( event, ui ) {
			var id = ui.item.label;
			var name = ui.item.name;
			var user_id =  ui.item.value;
			/*var phone_number =  ui.item.primary_phone;
			if(phone_number == '')
			{
				$("#pre-assign_volunteer-airline").val(' ');
				$("#pre-assign_volunteer-airline-id" ).val('0');
				alert('This User has not submitted phone number in profile page');
			} else {*/
				$("#pre-assign_volunteer-airline").val(name);
				$("#pre-assign_volunteer-airline-id" ).val(user_id);
			//}
				return false;
		},     
		select: function( event, ui ) {
			var id = ui.item.label;
			var name = ui.item.name;
			var user_id =  ui.item.value;
			var phone_number =  ui.item.primary_phone;
			if(phone_number == '')
			{
				$("#pre-assign_volunteer-airline").val(' ');
				$("#pre-assign_volunteer-airline-id" ).val('0');
				alert('This user has not submitted phone number in general profile page');
			} else {
				$("#pre-assign_volunteer-airline").val(name);
				$("#pre-assign_volunteer-airline-id").val(user_id);
			}
			return false;
		}
	});	
});


	$(document).on('change','#pre-assign_volunteer-airline',function()
	{
		var term = $('#pre-assign_volunteer-airline').val().replace(/\s/g,'');
		if(term!='')
		{
		$.ajax({
            url: base_url+"org_transportation/get_all_airlinebases/",
            dataType: "json",
            data:
            {
                term: term,
            },
            success: function (data)
            {
				if(data)
				{
					var id = data[0].label;
					var name =data[0].name;
					var user_id =  data[0].value;
					if(data[0].primary_phone == '')
					{
						$("#pre-assign_volunteer-airline").val(' ');
						$("#pre-assign_volunteer-airline-id" ).val('0');
						alert('This user has not submitted phone number in general profile page');
					} else {
						$("#pre-assign_volunteer-airline").val(name);
						$("#pre-assign_volunteer-airline-id").val(user_id);
					}
				}
				else
				{
					if(data == null || data === '' || data == '0')
					{
						$("#pre-assign_volunteer-airline").val(' ');
						$("#pre-assign_volunteer-airline-id" ).val('0');
					}
				}
			}
		});	
		} else {
			$("#pre-assign_volunteer-airline").val(' ');
			$("#pre-assign_volunteer-airline-id" ).val('0');
		}		
  
});
	

		$(document).ready(function(){
			
			$.validator.addMethod("telephone_number", function (value, element) {
				 var a = /^(1\s|1|)?((\(\d{3}\))|\d{3})(\-|\s)?(\d{3})(\-|\s)?(\d{4})$/.test(value);
				return a;
		},'Please enter valid telephone number');
		
		$.validator.addMethod("non_zero_number", function (value, element) {
						//return this.optional(element) || value != '0';
						return parseInt(value) !== 0;
		},'Please enter valid zip code');
			
		    $('#non_doobert_user_frm').validate({
					errorElement: 'span', //default input error message container
					errorClass: 'help-block', // default input error message class
					focusInvalid: true, // do not focus the last invalid input
					rules: {
						non_doobert_user_name: {
							required: true
						},
						non_doobert_user_phone: {
							required: true,
							telephone_number:true
						},
						non_doobert_user_email: {
							required: true,
							email:true
						},
						non_doobert_user_vehicle_zipcode: {
							required: true,
							non_zero_number: true
						},
						/*non_doobert_user_vehicle_type: {
							required: true
						}*/												
					},
			
					messages: {
						non_doobert_user_name: {
							required: 'Please Enter Name.'
						},
						non_doobert_user_phone: {
							required: 'Please Enter Phone Number.'
						},
						non_doobert_user_email: {
							required: 'Please Enter Email.',
							email: 'Please Enter Valid Email.'
						},
						non_doobert_user_vehicle_zipcode: {
							required: 'Please Enter Zipcode.'
						}
						
					},
			
					invalidHandler: function (event, validator) { //display error alert on form submit   
						$('#assign-nondoobert-user').show();
						
						var errors = validator.numberOfInvalids();
						if (errors) {
						  var message = errors == 1
							? 'You missed 1 field. It has been highlighted'
							: 'You missed ' + errors + ' fields. They have been highlighted';
						  alert(message);
						}
					},
			
					highlight: function (element) { // hightlight error inputs
						$(element)
							.closest('.form-group').addClass('has-error'); // set error class to the control group
					},
			
					success: function (label) { //alert(label);
						label.closest('.form-group').removeClass('has-error');
						label.remove();
					},
			
					errorPlacement: function (error, element) { 
						error.addClass('help-block').insertAfter(element.closest('.form-control'));
					}
			
				
	 });

		$(document).on('click','#close_non_doobert_user_form,#non_doobert_cancel',function(){
				location.reload();
		});
	
		$(document).on('click','#non_doobert_assign_leg',function(e){
			$('#non_doobert_user_assign_and_invite').val('0');
			
		if($('#non_doobert_user_frm').valid() == false) {
			return false;
		} else {
		
			var non_doobert_email_id = $('#non_doobert_user_email').val();
			
			//alert(non_doobert_email_id);
			$.ajax({
			type: "POST",
				  url: base_url+'org_transportation/check_non_doobert_exists',
				  beforeSend: function() {
					$('#non-doobert_leg_loader').modal('toggle');
					
				  },
				  data: {
					  email_id : non_doobert_email_id
				  },
				  dataType:"json",
				  complete: function() {
					$('#non-doobert_leg_loader').modal('hide');
				  },
				  success:function(data) {
					  //alert(data);
				
					  //alert(data.st_display_name);
					  //alert(data.st_last_name);
					  //alert(data.in_user_id);
					  if(data !=null && data.in_user_id > 0  )
					  {
						
						//if(data.st_primary_phone!='' && data.st_driver== 'Y')
						//{	
							$('#match_doobert_user_popup_email_add').html(non_doobert_email_id);
							$('#match_doobert_user_popup_email_name').html(data.st_display_name+' '+data.st_last_name);
							$('#matched_doobert_user_id').val(data.in_user_id);
							$('#matched_doobert_user_email').val(data.st_email);
							$('#matched_doobert_transport_id').val($('#non_doobert_user_transport_id').val());
							$('#matched_doobert_leg_id').val($('#non_doobert_user_transport_leg_id').val());
							$('#matched_doobert_user_name').val(data.st_display_name+' '+data.st_last_name);
							var telephone_number = $('#non_doobert_user_phone').val();
							$('#matched_phone_number').val(telephone_number);
							$('#matched_doobert_user_zip').val($('#non_doobert_user_vehicle_zipcode').val());
							$('#match_doobert_user_popup').modal('show');
							//e.preventDefault();							
							return false;
						/*} else {
							//alert("this user cannot be selected");
							$('#noneuser_match_doobert_user_popup').modal('show');
							return false;
						}*/
						
					  }else{
						 if($.browser.msie) {
									$('.display_loader').html('<img id="loadimg" src="'+base_url+'assets/img/ajax-loading.gif" alt="loader" />');
								}
							$('.display_loader').show();
							
							$('#loadimg_mail').show();
							$('#assign-nondoobert-user').modal('hide');
							
							if($.browser.msie) {
								$('.display_loader').html('<div id="loader" style="display: none;"><img src="'+base_url+'assets/img/ajax-modal-loading.gif" width="32" height="32" align="absmiddle">&nbsp;<span id="loadertext">Loading...</span></div>');
							}
							
							$('.display_loader').show();
							$('#loader').show();
							$('#non_doobert_user_frm').submit();
							
						 }
					 
				  }
		});
		}
		}); 
		
		$(document).on('click','#non_doobert_assign_leg_invite',function(){			
			$('#non_doobert_user_assign_and_invite').val('1');
		
		if($('#non_doobert_user_frm').valid() == false) {
			return false;
		} else {
			
			var non_doobert_email_id = $('#non_doobert_user_email').val();
			
			//alert(non_doobert_email_id);
			$.ajax({
			type: "POST",
				  url: base_url+'org_transportation/check_non_doobert_exists',
				  beforeSend: function() {
					$('#non-doobert_leg_loader').modal('toggle');
					
				  },
				  data: {
					  email_id : non_doobert_email_id
				  },
				  dataType:"json",
				  complete: function() {
					$('#non-doobert_leg_loader').modal('hide');
				  },
				  success:function(data) {
					  
					  if(data !=null && data.in_user_id > 0)
					  {
						//if(data.st_primary_phone!='' && data.st_driver== 'Y')
						//{	
							$('#match_doobert_user_popup_email_add').html(non_doobert_email_id);
							$('#match_doobert_user_popup_email_name').html(data.st_display_name+' '+data.st_last_name);
							$('#matched_doobert_user_id').val(data.in_user_id);
							$('#matched_doobert_user_email').val(data.st_email);
							$('#matched_doobert_transport_id').val($('#non_doobert_user_transport_id').val());
							$('#matched_doobert_leg_id').val($('#non_doobert_user_transport_leg_id').val());
							$('#matched_doobert_user_name').val(data.st_display_name+' '+data.st_last_name);
							var telephone_number = $('#non_doobert_user_phone').val();
							$('#matched_phone_number').val(telephone_number);
							$('#matched_doobert_user_zip').val($('#non_doobert_user_vehicle_zipcode').val());
							$('#match_doobert_user_popup').modal('show');	
							return false;
						/*} else {
							
							$('#noneuser_match_doobert_user_popup').modal('show');
							return false;
						}*/
					  }else{
						 if($.browser.msie) {
									$('.display_loader').html('<img id="loadimg" src="'+base_url+'assets/img/ajax-loading.gif" alt="loader" />');
								}
							$('.display_loader').show();
							
							$('#loadimg_mail').show();
							$('#assign-nondoobert-user').modal('hide');
							
							if($.browser.msie) {
								$('.display_loader').html('<div id="loader" style="display: none;"><img src="'+base_url+'assets/img/ajax-modal-loading.gif" width="32" height="32" align="absmiddle">&nbsp;<span id="loadertext">Loading...</span></div>');
							}
							
							$('.display_loader').show();
							$('#loader').show();
							$('#non_doobert_user_frm').submit();
							return false;
						 }
					 
				  }
		});
		}
		
		});

	$(document).on('blur','#non_doobert_user_email',function(){
	var non_doobert_email_id = $('#non_doobert_user_email').val();
			
			//alert(non_doobert_email_id);
			$.ajax({
			type: "POST",
				  url: base_url+'org_transportation/get_non_doobert_exists',
				  /*beforeSend: function() {
					$('#loader').show();
				  },*/
				  data: {
					  email_id : non_doobert_email_id
				  },
				  dataType:"json",
				  complete: function() {
					 $('#loader').hide();
				  },
				  success:function(data) {
					  
					  if(data !=null && data.in_user_id > 0)
					  {
						//if(data.st_primary_phone!='' && data.st_driver== 'Y')
						//{	
							$('#non_doobert_user_name').val(data.st_display_name+' '+data.st_last_name);
							$('#non_doobert_user_phone').val(data.st_primary_phone);
							$('#non_doobert_user_vehicle_zipcode').val(data.st_zip);
							$('#non_doobert_user_vehicle_type').val(data.st_zip);
							$('#non_doobert_user_vehicle_license_plate').val(data.st_vehicle_license_plate);
							$('#non_doobert_user_vehicle_license_state').val(data.st_vehicle_license_state);
							$('#non_doobert_user_vehicle_type').val(data.st_vehicle_type);
							$('#non_doobert_user_vehicle_color').val(data.st_vehicle_color);	
							return false;
						//}
					  }
					 
				  }
		});
		});
		
$(document).on('click','#close_non_doobert_user_form,#non_doobert_cancel',function(){

		location.reload();
		});		
		
$(document).on('click','#modal_confirm_match_user',function(){
			$('#non_doobert_match_user_frm').submit();
			}); 
	});
	
$(document).on('click','#auto_split_leg',function(){

	if(myArray.length>0)
	{
		$('#auto_split_modal').modal('show');	
	} else {
		$('#break-route-legs').modal('show');
	}		
});	

function timeConvertor(time) 
{
    var PM = time.match('PM') ? true : false
    
    time = time.split(':')
    var retrive_min = time[1];
    var min = retrive_min.split(" ");
	var minutes = min[0];
    if (PM && time[0]!='12') 
	{
        var hour = 12 + parseInt(time[0],10)
        var sec = '00';
    } else {
        //var hour = time[0]
		//var hour = time[0] > 9 ?time[0]: "0" + time[0];
		var hour = time[0] <= 9 && time[0].length<=1 ?"0" + time[0]:time[0];
        var sec = '00';       
    }
	var exact_time = hour + ':' + minutes + ':' + sec;
    return exact_time;
}

$(document).on('click','#btn_continue',function(){

	var distance_duration = $("#distance_duration").val();
	var handoff_time = $("#handoff_time").val();
	var break_by = 'd';
	var error_msg = '';
	var error_status = 0;

		if(distance_duration == '')
		{
			//alert('Please enter distance.');
			//return false;
			error_msg = 'Please enter distance.\n';
			error_status = 1;
		}
		
		if(distance_duration < 30)
		{
			//alert('Break by distance value should be Greater then or Equal to 30 Miles.');
			error_msg += 'Break by distance value should be Greater then or Equal to 30 Miles.\n';
			error_status = 1;
			//return false;
		}
		
		if(handoff_time == '')
		{
			//alert('Please enter handoff time between legs.');
			error_msg += 'Please enter handoff time between legs. \n';
			error_status = 1;
			//return false;
		}
		
		
		var timepicker1 = new Array;
		var timepicker2 = new Array;
		$('.timepicker1').each(function()
		{
			timepicker1.push($(this).val());
		});
			
		$('.timepicker2').each(function()
		{
			timepicker2.push($(this).val());
		});
		
		for(var i=0;i<total_diff;i++)
		{
			var time_pick1 = timeConvertor(timepicker1[i]);
			var time_pick2 = timeConvertor(timepicker2[i]);
			var day = parseInt(i)+parseInt(1);
			if(time_pick1 > time_pick2)
			{
				error_msg += 'Latest leg finish time must be greater then Earliest leg start time for day '+day+' \n';
				error_status = 1;	
			}		
		}
		
		if(error_status == 1)
		{
			alert(error_msg);
			return false;
		}	
	
	
	var form_distance_duration = $("#distance_duration").val();
	var form_handoff_time      = $("#handoff_time").val();
		
	$.ajax({
            url: base_url+"org_transportation/auto_split_transport_legs/",
			type:"POST",
            dataType: "json",
            data:
            {
                form_timepicker1:timepicker1,
				form_timepicker2:timepicker2,
				form_distance_duration:form_distance_duration,
				form_handoff_time:form_handoff_time,
				transport_id:transport_id
            },
			beforeSend:function(data)
			{
				$('#auto_split_loader').modal('show');
				$('#break-route-legs').modal('hide');
			},	
            success: function(data)
            {
				if(data == '1')
				{	
					var cname = 'edit_legs';
					var cvalue = '1';
					var exdays = '1';
					var d = new Date();
					d.setTime(d.getTime() + (exdays*24*60*60*1000));
					var expires = "expires="+ d.toUTCString();
					document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;domain=.doobert.com";
					window.location = base_url+'transport-create-legs/';
				} 		
				else
					alert('Auto-split transport route not created succesfully');	
            },
			complete:function(data)
			{
				$('#auto_split_loader').modal('hide');
			}
	});
});
	
		/*$(document).ready(function()
		{
			$(document).on('click','#cancel_only',function()
			{
				if(confirm('Are you sure you want to cancel transportation?'))
				{
					$('#cancel-transport-description').modal('show');
					//$('#cancel_transport').submit();
				}else{ 
					$('#select-action').val('0');
					return false; 
				}
			});

		$(document).on('click','#reason-cancel-transport',function(e){
			
			var cancel_msg = $('#cancelmessage').val();	
			var error_msg=0;
			if(cancel_msg=='')
			{
				error_msg =1;
				alert('Please enter the message');
			}
			if(error_msg == 0)
			{
				$('#save_legs,#save_draft,#add_aviation_leg_g,#add_aviation_leg_a,#save_only,#cancel_only').hide();	
				$('#cancel-transport-description').modal('hide');
				$('#transport_loader_cancel').modal('show');
				$('#cancel_trans_text').val(cancel_msg);	
				$('#cancel_transport').submit();
			}
		});
			
	});*/
	